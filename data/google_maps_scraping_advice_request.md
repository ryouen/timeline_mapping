# Google Maps スクレイピング技術相談書

## 🎯 解決したい問題

Google Mapsから公共交通機関（電車・バス）のルート情報をスクレイピングするシステムを開発しています。9件中8件は成功していますが、**短距離（1-2km）の東京駅ルートが車ルートとして取得されてしまう**問題を解決したいです。

## 📊 現在の状況

### 成功率
- **9件中8件成功**: 正しく公共交通機関ルートを取得
- **1件問題あり**: 東京駅ルートが車ルート（9分、道路経由）として表示

### 技術スタック
- Python 3.x + Selenium WebDriver
- Docker コンテナ内実行（Selenium Grid使用）
- Google Maps URL直接アクセス方式（APIキー不使用）
- 2ステップ戦略実装済み

### 2ステップ戦略の詳細
1. **ステップA（場所解決）**: 住所から座標とPlace IDを取得
2. **ステップB（ルート検索）**: 取得した情報でルートURL構築

## 🔧 実装済みのコード

### URL生成ロジック

```python
def build_complete_url(origin_info, dest_info, arrival_time):
    """Google Maps URLを構築"""
    base_url = "https://www.google.com/maps/dir/"
    path = f"{quote(origin['name'])}/{quote(dest['name'])}"
    
    # data=パラメータブロックの構築
    data_parts = []
    data_parts.append("!4m18!4m17")  # コンテナ
    
    # 出発地（座標のみ、Place IDなし）
    data_parts.append("!1m5")
    if origin_info.get('lat') and origin_info.get('lng'):
        data_parts.append(f"!2m2!1d{origin_info['lng']}!2d{origin_info['lat']}")
    
    # 目的地（座標のみ、Place IDなし）
    data_parts.append("!1m5")
    if dest_info.get('lat') and dest_info.get('lng'):
        data_parts.append(f"!2m2!1d{dest_info['lng']}!2d{dest_info['lat']}")
    
    # 時刻指定（到着時刻）
    data_parts.append("!2m3!6e1!7e2")
    data_parts.append(f"!8j{int(arrival_time.timestamp())}")
    
    # 公共交通機関モード
    data_parts.append("!3e3")  # transit mode
    
    return base_url + path + "/data=" + "".join(data_parts)
```

### Place ID取得の現状

```python
def get_place_details(address, driver):
    """住所からプレイスIDと座標を取得"""
    search_url = f"https://www.google.com/maps?q={quote(address)}"
    driver.get(search_url)
    
    # URLから座標を抽出
    coord_match = re.search(r'@(-?\d+\.\d+),(-?\d+\.\d+)', current_url)
    
    # Place IDを抽出（問題: 0x形式しか取得できない）
    place_id_match = re.search(r'!1s(0x[0-9a-fA-F:]+)', current_url)
    # 結果例: "0x60188c02f64e1cd9:0x8f6b5d9a1c0e2a40" (不完全な形式)
    
    # 理想: "ChIJb_UG0SOOGGARY5_G94544yk" (完全なChIJ形式)
```

## ✅ 成功例の詳細分析

### 1. Shizenkan University（日本橋）- 7分
```
出発地: 東京都千代田区神田須田町1-20-1（ルフォンプログレ）
目的地: 東京都中央区日本橋２丁目５−１

URL: https://www.google.com/maps/dir/東京都千代田区神田須田町1-20-1/東京都中央区日本橋２丁目５−１/data=!4m18!4m17!1m5!2m2!1d139.768563!2d35.6949994!1m5!2m2!1d139.7712416!2d35.6811282!2m3!6e1!7e2!8j1755306000!3e3

結果: 銀座線で7分（正しい公共交通機関ルート）✅
座標距離: 約1.5km
```

### 2. 東京アメリカンクラブ - 7分
```
目的地: 東京都中央区日本橋室町３丁目２−１
結果: 銀座線で7分 ✅
座標距離: 約1.6km
```

### 3. axle御茶ノ水 - 13分
```
目的地: 東京都千代田区神田小川町３丁目２８−５
結果: 公共交通機関で13分 ✅
座標距離: 約1.0km
```

### 4. 府中オフィス - 62分
```
目的地: 東京都府中市住吉町５丁目２２−５
結果: 新宿線→京王線で62分 ✅
座標距離: 約30km（長距離）
```

## ❌ 問題例の詳細分析

### 東京駅（丸の内）- 9分が車ルートになる
```
出発地: 東京都千代田区神田須田町1-20-1（ルフォンプログレ）
目的地: 東京都千代田区丸の内１丁目

URL: https://www.google.com/maps/dir/東京都千代田区神田須田町1-20-1/東京都千代田区丸の内１丁目/data=!4m18!4m17!1m5!2m2!1d139.768563!2d35.6949994!1m5!2m2!1d139.7551989!2d35.6814997!2m3!6e1!7e2!8j1755306000!3e3

結果: 「中央通り/中山道/国道17号」経由9分（車ルート）❌
期待: 山手線または中央線で2-3分
座標距離: 約1.3km
```

## 🔍 調査済みの内容

### 1. URLパラメータの試行
- `!3e3`: 公共交通機関モード指定 → **設定済み**
- `!6e1`: 到着時刻指定 → **設定済み**
- `!8j{timestamp}`: Unix タイムスタンプ → **設定済み**
- `?travelmode=transit`: クエリパラメータ → **削除済み**（!3e3と重複）

### 2. 車ルート検出ロジック
```python
# 現在の実装
highway_names = ['首都高速', '中央自動車道', '東名高速']
car_indicators = ['車で', '自動車']
transit_indicators = ['駅', '線', '電車', 'バス', '徒歩', '乗換', '発', '着']

# 高速道路名が含まれている場合のみ車ルートと判定
```

### 3. Seleniumでの対策
```python
# 公共交通機関ボタンを明示的にクリック
transit_button_selectors = [
    "//button[@aria-label='公共交通機関']",
    "//button[@data-travel-mode='3']",
    "//div[@data-value='3']//button"
]
# → 効果なし（東京駅は依然として車ルート）
```

## 🤔 仮説と考察

### 仮説1: Place IDの欠如が原因
- **現状**: 座標のみ使用（`!2m2!1d...!2d...`）
- **理想**: Place ID付き（`!1m1!1sChIJ...`）
- **影響**: Google Mapsが場所を正確に認識できない？

### 仮説2: 距離による自動切り替え
- **1.0km（axle）**: 公共交通機関 ✅
- **1.3km（東京駅）**: 車ルート ❌
- **1.5km（Shizenkan）**: 公共交通機関 ✅
- **境界線が不明確**

### 仮説3: 地名の曖昧性
- 「丸の内１丁目」という広い地域指定
- より具体的な施設名や駅名が必要？

## ❓ 具体的な質問

### 1. 短距離での公共交通機関強制について
- `!3e3`パラメータ以外に、公共交通機関を強制する方法はありますか？
- 距離による自動切り替えを無効化するパラメータは存在しますか？
- `!5e0`（避けるモード？）や他の未知のパラメータはありますか？

### 2. Place IDの重要性と取得方法
- 座標のみとPlace ID付きでルート検索の挙動は変わりますか？
- 不完全な`0x`形式のPlace IDでも使用する価値はありますか？
- ChIJ形式のPlace IDを確実に取得する方法は？
- Place APIを使わずにChIJ形式を取得する裏技は？

### 3. URL構造の最適化
- data=ブロックの順序は結果に影響しますか？
- `!4m18!4m17`のような数値の意味と調整方法は？
- 省略可能/必須のパラメータの区別は？

### 4. 代替アプローチの提案
- JavaScriptを実行して内部APIを直接呼び出す方法？
- モバイル版URLの方が安定している？
- 出発時刻指定（`!6e0`）vs 到着時刻指定（`!6e1`）の違いは？
- 複数の中継地点を設定して強制的に駅を経由させる？

### 5. 東京駅特有の問題への対処
- 「東京駅」という駅名を直接使用すべき？
- 駅の座標（改札口など）をピンポイントで指定？
- 近隣の明確なランドマーク（大丸など）を使用？

## 📎 制約条件と要件

### 制約
- Google Maps API キー使用不可（スクレイピングのみ）
- Dockerコンテナ内実行（Selenium Grid環境）
- リクエスト頻度の制限あり（3秒間隔）

### 要件
- 明日10時到着の時刻指定必須
- 日本時間（JST、UTC+9）対応
- 公共交通機関（電車・バス）のみ取得
- 最短時間のルート選択

## 🙏 期待する回答

1. **即効性のある解決策**: 東京駅ルートを公共交通機関として取得する具体的な方法
2. **URLパラメータの詳細仕様**: 未知のパラメータや組み合わせ
3. **Place ID取得の改善策**: ChIJ形式を確実に取得する方法
4. **ベストプラクティス**: Google Mapsスクレイピングの安定化テクニック
5. **代替案**: 問題が解決しない場合の回避策

## 📧 連絡先と追加情報

このドキュメントは、Google Mapsスクレイピングシステムの改善のための技術相談資料です。
プロジェクトの詳細や追加の技術情報が必要な場合は、お知らせください。

---
*作成日: 2025年8月15日*
*プロジェクト: timeline-mapping*
*バージョン: v3*