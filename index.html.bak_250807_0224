<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>æ™‚é–“è·é›¢ãƒãƒƒãƒ— - å±…ä½åœ°è¦–ç‚¹</title>
    <style>
        /* ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªè‰²å®šç¾©ã¨ã‚¹ãƒšãƒ¼ã‚·ãƒ³ã‚° */
        :root {
            --color-walk: #FFA726;
            --color-train: #42A5F5;
            --color-transfer: #EF5350;
            --color-walk-gradient: linear-gradient(90deg, #FFA726, #FFB74D);
            --color-train-gradient: linear-gradient(90deg, #42A5F5, #64B5F6);
            --color-transfer-gradient: linear-gradient(90deg, #EF5350, #E57373);
            
            /* ã‚¹ãƒšãƒ¼ã‚·ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ  */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 12px;
            --spacing-lg: 16px;
            --spacing-xl: 20px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Noto Sans JP', sans-serif;
            background: #000;
            color: white;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        #container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        #canvas {
            width: 100%;
            height: 100%;
            cursor: grab;
        }

        #canvas.grabbing {
            cursor: grabbing;
        }

        /* ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç”¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
        #controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 100;
            max-width: 380px;
            backdrop-filter: blur(10px);
        }

        h2 {
            margin-top: 0;
            font-size: 18px;
            margin-bottom: 15px;
        }

        .control-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #aaa;
        }

        select {
            width: 100%;
            padding: 10px;
            background: rgba(20, 20, 20, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 5px;
            font-size: 13px;
            cursor: pointer;
        }

        select:hover {
            border-color: rgba(255, 255, 255, 0.4);
        }

        select:focus {
            outline: none;
            border-color: rgba(100, 200, 255, 0.6);
            background: rgba(30, 30, 30, 0.9);
        }

        .area-info {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            font-size: 13px;
            max-height: 320px;
            overflow-y: auto;
        }

        .area-info .rent {
            color: #ffc107;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .area-info .stations {
            color: #64c8ff;
            margin-bottom: 5px;
        }

        .area-info .score {
            color: #4ecdc4;
            margin-bottom: 10px;
        }
        
        .area-info .total-time {
            color: #ff6b6b;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .area-info .walk-time {
            color: #ffa726;
            margin-bottom: 5px;
        }

        /* å³ä¸Šã®æƒ…å ±ãƒ‘ãƒãƒ« */
        .info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 13px;
            max-width: 250px;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        /* å‡¡ä¾‹ */
        .legend {
            position: absolute;
            bottom: 20px; /* 100px ã‹ã‚‰ 20px ã«æˆ»ã™ */
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 13px;
            max-width: 300px;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .legend h4 {
            margin-top: 0;
            margin-bottom: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .legend-color {
            width: 20px;
            height: 4px;
            border-radius: 2px;
            display: inline-block;
        }
        
        .legend-color.walk {
            background: linear-gradient(90deg, rgba(255, 193, 7, 0.9), rgba(255, 193, 7, 0.7));
        }
        
        .legend-color.train {
            background: linear-gradient(90deg, rgba(100, 200, 255, 0.9), rgba(100, 200, 255, 0.7));
        }
        
        .legend-color.transfer {
            background: linear-gradient(90deg, rgba(255, 100, 100, 0.9), rgba(255, 100, 100, 0.7));
        }

        /* ã‚ºãƒ¼ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
        .zoom-controls {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .zoom-btn {
            padding: 5px 10px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .zoom-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        #zoomLevel {
            min-width: 50px;
            text-align: center;
            color: #aaa;
        }

        /* ç›®çš„åœ°ãƒãƒ¼ã‚«ãƒ¼ */
        .destination-marker {
            position: absolute;
            width: 16px;
            height: 16px;
            background: #ff4444;
            border: 2px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 25;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
            transition: transform 0.2s;
        }

        .destination-marker.partner {
            background: #44ff44;
        }

        .destination-marker.shared {
            background: #ffff44;
        }

        .destination-marker:hover {
            transform: translate(-50%, -50%) scale(1.3);
            z-index: 30;
        }

        .destination-label {
            position: absolute;
            background: rgba(0, 0, 0, 0.7);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            transform: translateX(-50%);
            margin-top: 15px;
            z-index: 24;
            pointer-events: none;
        }

        /* ãƒ›ãƒ¼ãƒ ãƒãƒ¼ã‚«ãƒ¼ */
        .home-marker {
            position: absolute;
            width: 40px;
            height: 40px;
            background: radial-gradient(circle, rgba(255, 255, 255, 1) 0%, rgba(255, 255, 255, 0.7) 50%, transparent 70%);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 30;
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.8);
            pointer-events: none;
        }

        .home-marker::before {
            content: 'ğŸ ';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 20px;
        }

        /* çµŒè·¯ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ */
        .route-segment {
            position: absolute;
            height: 8px;
            transform-origin: left center;
            transition: all 0.3s;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .route-segment.walk {
            background: linear-gradient(90deg, rgba(255, 193, 7, 0.9), rgba(255, 193, 7, 0.7));
            border: 1px solid rgba(255, 193, 7, 0.5);
            z-index: 12;
        }

        .route-segment.train {
            background: linear-gradient(90deg, rgba(100, 200, 255, 0.9), rgba(100, 200, 255, 0.7));
            border: 1px solid rgba(100, 200, 255, 0.5);
            z-index: 11;
        }

        .route-segment.transfer {
            background: linear-gradient(90deg, rgba(255, 100, 100, 0.9), rgba(255, 100, 100, 0.7));
            border: 1px solid rgba(255, 100, 100, 0.5);
            z-index: 12;
        }

        .route-segment.shared {
            height: 12px;
            background: linear-gradient(90deg, rgba(100, 200, 255, 0.9), rgba(100, 200, 255, 0.7));
            border: 1px solid rgba(100, 200, 255, 0.5);
            z-index: 13;
        }

        .route-segment:hover {
            height: 12px;
            margin-top: -2px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            z-index: 20;
        }

        /* æ™‚é–“æƒ…å ±ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— */
        .time-info {
            position: absolute;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 6px;
            font-size: 12px;
            color: white;
            z-index: 50;
            max-width: 250px;
            pointer-events: none;
            display: none;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        /* ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆ */
        .bottom-sheet {
            display: none;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(28, 28, 30, 0.7);
            border-radius: 20px 20px 0 0;
            z-index: 200;
            transform: translateY(calc(100% - 120px));
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding-bottom: env(safe-area-inset-bottom);
            box-shadow: 0 -2px 20px rgba(0,0,0,0.3);
        }

        .bottom-sheet.expanded {
            transform: translateY(0);
            max-height: 70vh;
        }

        .sheet-handle {
            width: 36px;
            height: 5px;
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
            margin: 8px auto;
            cursor: grab;
        }

        .sheet-content {
            padding: 0 20px 20px;
            max-height: 50vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .property-chips {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 10px;
            margin-bottom: 15px;
            -webkit-overflow-scrolling: touch;
        }

        .property-chip {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 16px;
            padding: 8px 16px;
            font-size: 14px;
            white-space: nowrap;
            transition: all 0.2s;
            flex-shrink: 0;
            cursor: pointer;
        }

        .property-chip.active {
            background: #007AFF;
            border-color: #007AFF;
        }

        /* ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ - æœ€ä¸Šä½ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆz-indexå•é¡Œã®å®Œå…¨è§£æ±ºï¼‰ */
        .view-mode-toggle {
            position: fixed;
            top: 12px;
            right: 12px;
            z-index: 10000;
            display: flex;
            gap: 2px;
            background: rgba(0, 0, 0, 0.7);
            padding: 2px;
            border-radius: 5px;
            border: 1px solid rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(15px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }
        
        .view-mode-btn {
            padding: 4px 10px;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 11px;
            font-weight: 500;
            height: 24px;
            display: flex;
            align-items: center;
            line-height: 1;
        }
        
        .view-mode-btn.active {
            background: rgba(100, 200, 255, 0.2);
            color: #64c8ff;
        }
        
        .view-mode-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.8);
        }
        
        /* ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠ */
        .view-container {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .view-container.active {
            display: block;
        }
        
        /* æ¯”è¼ƒãƒ“ãƒ¥ãƒ¼ - æ™‚é–“è»¸ãƒãƒ¼ã‚°ãƒ©ãƒ•å½¢å¼ */
        .compare-view {
            padding: 30px;
            height: 100%;
            overflow-y: auto;
            background: #000;
        }
        
        .compare-header {
            margin-bottom: 30px;
            text-align: center;
        }
        
        .compare-title {
            font-size: 20px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 15px;
        }
        
        .compare-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }
        
        .compare-legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .compare-legend-color {
            width: 20px;
            height: 4px;
            border-radius: 2px;
        }
        
        .compare-destinations {
            margin-left: 350px;  /* ç‰©ä»¶ã‚«ãƒ¼ãƒ‰å³ç«¯(20+268+1.778+40) + ä½™ç™½20px */
            margin-right: 20px;   /* å³ç«¯ã‹ã‚‰ã®ä½™ç™½ */
            width: calc(100% - 370px); /* æ®‹ã‚Šã®å¹…ã‚’ä½¿ç”¨ */
        }
        
        /* æ¯”è¼ƒãƒ“ãƒ¥ãƒ¼ã®æ¨ªæ£’ã‚°ãƒ©ãƒ• - å¾¹åº•çš„ãªé«˜ã•åœ§ç¸® */
        .compare-view {
            padding: 15px;
            height: 100%;
            overflow-y: auto;
            background: #000;
        }
        
        .compare-header {
            margin-bottom: 15px;
            text-align: center;
        }
        
        .compare-title {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 8px;
        }
        
        .compare-legend {
            display: flex;
            justify-content: center;
            gap: 15px;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
        }
        
        .compare-legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .compare-legend-color {
            width: 16px;
            height: 3px;
            border-radius: 2px;
        }
        
        .compare-destinations {
            margin-left: 350px;  /* ç‰©ä»¶ã‚«ãƒ¼ãƒ‰å³ç«¯(20+268+1.778+40) + ä½™ç™½20px */
            margin-right: 20px;   /* å³ç«¯ã‹ã‚‰ã®ä½™ç™½ */
            width: calc(100% - 370px); /* æ®‹ã‚Šã®å¹…ã‚’ä½¿ç”¨ */
        }
        
        .destination-comparison {
            background: rgba(20, 20, 20, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
        }
        
        .destination-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .destination-name {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
        }
        
        .destination-frequency {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
        }
        
        .axis-labels {
            display: flex;
            justify-content: space-between;
            font-size: 9px;
            color: rgba(255, 255, 255, 0.35);
            margin-bottom: 6px;
            padding: 0 3px;
        }
        
        .property-comparison {
            margin-bottom: 4px;
        }
        
        .property-label {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 2px;
        }
        
        .property-label.current {
            color: #64c8ff;
            font-weight: 600;
        }
        
        .time-bar-container {
            position: relative;
            height: 18px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 9px;
            margin-bottom: 4px;
            margin-left: 55px;
        }
        
        .time-bar {
            position: absolute;
            height: 100%;
            border-radius: 9px;
            display: flex;
            align-items: center;
            overflow: hidden;
            box-sizing: border-box;
            font-size: 0; /* éš™é–“ã‚’é˜²ã */
        }
        
        .time-segment {
            display: inline-flex; /* inline-flexã«å¤‰æ›´ */
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: 500;
            color: white;
            position: relative;
            box-sizing: border-box;
            height: 100%;
            margin: 0;
            padding: 0;
            border: none;
            vertical-align: middle; /* middleã«å¤‰æ›´ */
            line-height: 1;
        }
        
        .time-total {
            position: absolute;
            left: -50px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 10px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
            text-align: right;
            width: 45px;
            white-space: nowrap;
        }
        
        .segment-walk {
            background: var(--color-walk-gradient);
        }
        
        .segment-train {
            background: var(--color-train-gradient);
        }
        
        .segment-transfer {
            background: var(--color-transfer-gradient);
        }
        
        .time-total {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            font-weight: 600;
            color: white;
            background: rgba(0, 0, 0, 0.5);
            padding: 2px 6px;
            border-radius: 10px;
        }
        
        .best-marker {
            position: absolute;
            right: -25px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
        }
        
        /* ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ“ãƒ¥ãƒ¼ - è‰²ã®å®Œå…¨çµ±ä¸€ã¨é«˜ã•ã®æœ€é©åŒ– */
        .ranking-view {
            padding: 15px;
            height: 100%;
            overflow-y: auto;
            background: #000;
        }
        
        .ranking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
        }
        
        .ranking-title {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
        }
        
        .ranking-filters {
            display: flex;
            gap: 8px;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
        }
        
        .ranking-list {
            margin-left: 350px;  /* ç‰©ä»¶ã‚«ãƒ¼ãƒ‰å³ç«¯(20+268+1.778+40) + ä½™ç™½20px */
            margin-right: 20px;   /* å³ç«¯ã‹ã‚‰ã®ä½™ç™½ */
            width: calc(100% - 370px); /* æ®‹ã‚Šã®å¹…ã‚’ä½¿ç”¨ */
        }
        
        .ranking-item {
            padding: 8px 0 8px 8px;  /* å·¦ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’æœ€åˆã‹ã‚‰è¨­å®š */
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.2s;
            cursor: pointer;
            position: relative;  /* ç–‘ä¼¼è¦ç´ ç”¨ */
        }
        
        /* å·¦ã®ç¸¦ç·šã¯ç–‘ä¼¼è¦ç´ ã§å®Ÿè£… */
        .ranking-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background: transparent;
            transition: background 0.2s;
        }
        
        .ranking-item:hover {
            background: rgba(255, 255, 255, 0.02);
        }
        
        .ranking-item.current::before {
            background: rgba(100, 200, 255, 0.8);
        }
        
        .ranking-item.current {
            background: rgba(100, 200, 255, 0.04);
        }
        
        .ranking-item-header {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .ranking-number {
            font-size: 16px;
            font-weight: bold;
            margin-right: 10px;
            min-width: 25px;
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .ranking-medal {
            font-size: 18px;
            margin-right: 10px;
        }
        
        .ranking-name {
            font-size: 14px;
            font-weight: 500;
            color: #fff;
            flex: 1;
        }
        
        .ranking-time-total {
            font-size: 15px;
            font-weight: 600;
            color: #ff6b6b;
        }
        
        .ranking-time-bar {
            position: relative;
            height: 16px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            margin-bottom: 6px;
            overflow: hidden;
        }
        
        .ranking-time-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, rgba(66, 165, 245, 0.25), rgba(100, 181, 246, 0.25));
            border: 1px solid rgba(66, 165, 245, 0.3);
            border-radius: 8px;
            position: relative;
        }
        
        .ranking-walk-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: var(--color-walk-gradient);
            opacity: 0.9;
            display: flex;
            align-items: center;
            padding-left: 6px;
            font-size: 9px;
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .ranking-details {
            display: flex;
            gap: 12px;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            padding-left: 35px;
        }
        
        .ranking-detail-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .ranking-detail-item strong {
            color: rgba(255, 255, 255, 0.85);
            font-weight: 500;
        }
        
        .ranking-details {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.6);
            padding-left: 35px;  /* ç•ªå·/ãƒ¡ãƒ€ãƒ«ã®å¹…ã‚’è€ƒæ…®ã—ã¦èª¿æ•´ */
        }
        
        .ranking-detail-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .ranking-detail-item strong {
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }
        
        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 1200px) {
            .compare-destinations, .ranking-list {
                margin-left: 350px;  /* ç‰©ä»¶ã‚«ãƒ¼ãƒ‰å³ç«¯(20+268+1.778+40) + ä½™ç™½20px */
                width: calc(100% - 370px);
            }
        }
        
        @media (max-width: 1024px) {
            .compare-view {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 767px) {
            #controls {
                display: none;
            }
            
            #compareControls, #rankingControls {
                display: none;
            }
            
            .info {
                display: none;
            }
            
            .legend {
                display: block;
                bottom: 100px; /* ãƒ¢ãƒã‚¤ãƒ«ç‰ˆã§ã®å‡¡ä¾‹ã®ä½ç½®èª¿æ•´ */
            }
            
            .bottom-sheet {
                display: block;
            }
            
            .compare-destinations, .ranking-list {
                margin-left: 20px;   /* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯å·¦ã®ä½™ç™½ã‚’æœ€å°é™ã« */
                margin-right: 20px;
                width: calc(100% - 40px); /* ç”»é¢å¹…ã‹ã‚‰å·¦å³ã®ä½™ç™½ã‚’å¼•ã„ãŸå¹… */
            }
            
            .compare-view {
                grid-template-columns: 1fr;
            }
            
            .ranking-view {
                padding: 20px;
            }
            
            .ranking-item {
                padding: 15px;
            }
            
            .ranking-number {
                font-size: 20px;
                margin-right: 15px;
            }
            
            .ranking-name {
                font-size: 16px;
            }
            
            .ranking-details {
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div id="container">
        <!-- å€‹åˆ¥ãƒ“ãƒ¥ãƒ¼ -->
        <div id="singleView" class="view-container active">
            <canvas id="canvas"></canvas>
            
            <!-- ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç”¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
            <div id="controls">
                <h2>ğŸ  å±…ä½åœ°ã‹ã‚‰è¦‹ãŸç›®çš„åœ°ãƒãƒƒãƒ—</h2>
                
                <div class="control-group">
                    <label>å±…ä½ç‰©ä»¶ã‚’é¸æŠ</label>
                    <select id="areaSelect" onchange="updateSelectedArea()">
                        <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
                    </select>
                </div>
                
                <div class="control-group">
                    <label>ä¸¦ã³é †</label>
                    <select id="sortOrder" onchange="updateSortOrder()">
                        <option value="time_desc">ç§»å‹•æ™‚é–“ã®çŸ­ã„é †</option>
                        <option value="walk_desc">å¾’æ­©æ™‚é–“ã®çŸ­ã„é †</option>
                        <option value="rent_asc">å®¶è³ƒã®å®‰ã„é †</option>
                    </select>
                </div>
                
                
                <div class="area-info" id="areaInfo">
                    <div class="rent">å®¶è³ƒ: -</div>
                    <div class="stations">æœ€å¯„é§…: -</div>
                    <div class="total-time">æœˆé–“ç·ç§»å‹•æ™‚é–“: -</div>
                    <div class="walk-time">ã†ã¡å¾’æ­©æ™‚é–“: -</div>
                </div>
            </div>
            
            <!-- æƒ…å ±ãƒ‘ãƒãƒ« -->
            <div class="info">
                <strong>ğŸ“ è¦‹æ–¹</strong><br>
                é¸æŠã—ãŸç‰©ä»¶ã‚’ä¸­å¿ƒã«ã€å„ç›®çš„åœ°ã¸ã®å®Ÿéš›ã®ç§»å‹•æ™‚é–“ãŒå¯è¦–åŒ–ã•ã‚Œã¾ã™ã€‚<br><br>
                ğŸ”´ ã‚ãªãŸã®ç›®çš„åœ°<br>
                ğŸŸ¢ ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã®ç›®çš„åœ°<br>
                ğŸŸ¡ å…±é€šã®ç›®çš„åœ°<br><br>
                <strong>ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«</strong>ã§ã‚ºãƒ¼ãƒ <br>
                <strong>ãƒ‰ãƒ©ãƒƒã‚°</strong>ã§ç§»å‹•<br><br>
                <div class="zoom-controls" style="margin-top: 10px;">
                    <button class="zoom-btn" onclick="zoom(0.8)">âˆ’</button>
                    <span id="zoomLevelInfo">200%</span>
                    <button class="zoom-btn" onclick="zoom(1.2)">ï¼‹</button>
                </div>
            </div>
            
            <!-- å‡¡ä¾‹ -->
            <div class="legend">
                <h4>ç§»å‹•çµŒè·¯</h4>
                <div class="legend-item">
                    <div class="legend-color walk"></div>
                    <span>å¾’æ­©</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color train"></div>
                    <span>é›»è»Š</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color transfer"></div>
                    <span>ä¹—ã‚Šæ›ãˆ</span>
                </div>
            </div>
        </div>
        
        <!-- æ¯”è¼ƒãƒ“ãƒ¥ãƒ¼ -->
        <div id="compareView" class="view-container">
            <div id="compareControls" style="position: absolute; top: 20px; left: 20px; background: rgba(0, 0, 0, 0.9); padding: 20px; border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.2); z-index: 100; max-width: 380px; backdrop-filter: blur(10px);">
                <h2>ğŸ  å±…ä½åœ°ã‹ã‚‰è¦‹ãŸç›®çš„åœ°ãƒãƒƒãƒ—</h2>
                
                <div class="control-group">
                    <label>å±…ä½ç‰©ä»¶ã‚’é¸æŠ</label>
                    <select id="compareAreaSelect" onchange="updateSelectedArea()">
                        <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
                    </select>
                </div>
                
                <div class="control-group">
                    <label>ä¸¦ã³é †</label>
                    <select id="compareSortOrder" onchange="updateSortOrder()">
                        <option value="time_desc">ç§»å‹•æ™‚é–“ã®çŸ­ã„é †</option>
                        <option value="walk_desc">å¾’æ­©æ™‚é–“ã®çŸ­ã„é †</option>
                        <option value="rent_asc">å®¶è³ƒã®å®‰ã„é †</option>
                    </select>
                </div>
                
                <div class="area-info" id="compareAreaInfo">
                    <div class="rent">å®¶è³ƒ: -</div>
                    <div class="stations">æœ€å¯„é§…: -</div>
                    <div class="total-time">æœˆé–“ç·ç§»å‹•æ™‚é–“: -</div>
                    <div class="walk-time">ã†ã¡å¾’æ­‰æ™‚é–“: -</div>
                </div>
            </div>
            <div class="compare-view">
                <div class="compare-header">
                    <h2 class="compare-title">ç›®çš„åœ°ã¸ã®ç§»å‹•æ™‚é–“æ¯”è¼ƒ</h2>
                    <div class="compare-legend">
                        <div class="compare-legend-item">
                            <div class="compare-legend-color" style="background: var(--color-walk);"></div>
                            <span>å¾’æ­©</span>
                        </div>
                        <div class="compare-legend-item">
                            <div class="compare-legend-color" style="background: var(--color-train);"></div>
                            <span>é›»è»Š</span>
                        </div>
                        <div class="compare-legend-item">
                            <div class="compare-legend-color" style="background: var(--color-transfer);"></div>
                            <span>ä¹—æ›</span>
                        </div>
                    </div>
                </div>
                <div class="compare-destinations" id="compareContent">
                    <!-- å‹•çš„ã«ç”Ÿæˆ -->
                </div>
            </div>
        </div>
        
        <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ“ãƒ¥ãƒ¼ -->
        <div id="rankingView" class="view-container">
            <div id="rankingControls" style="position: absolute; top: 20px; left: 20px; background: rgba(0, 0, 0, 0.9); padding: 20px; border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.2); z-index: 100; max-width: 380px; backdrop-filter: blur(10px);">
                <h2>ğŸ  å±…ä½åœ°ã‹ã‚‰è¦‹ãŸç›®çš„åœ°ãƒãƒƒãƒ—</h2>
                
                <div class="control-group">
                    <label>å±…ä½ç‰©ä»¶ã‚’é¸æŠ</label>
                    <select id="rankingAreaSelect" onchange="updateSelectedArea()">
                        <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
                    </select>
                </div>
                
                <div class="control-group">
                    <label>ä¸¦ã³é †</label>
                    <select id="rankingSortOrder" onchange="updateSortOrder()">
                        <option value="time_desc">ç§»å‹•æ™‚é–“ã®çŸ­ã„é †</option>
                        <option value="walk_desc">å¾’æ­©æ™‚é–“ã®çŸ­ã„é †</option>
                        <option value="rent_asc">å®¶è³ƒã®å®‰ã„é †</option>
                    </select>
                </div>
                
                <div class="area-info" id="rankingAreaInfo">
                    <div class="rent">å®¶è³ƒ: -</div>
                    <div class="stations">æœ€å¯„é§…: -</div>
                    <div class="total-time">æœˆé–“ç·ç§»å‹•æ™‚é–“: -</div>
                    <div class="walk-time">ã†ã¡å¾’æ­©æ™‚é–“: -</div>
                </div>
            </div>
            <div class="ranking-view">
                <div class="ranking-header">
                    <h2 class="ranking-title">ç‰©ä»¶ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
                    <div class="ranking-filters">
                        <span>â˜‘ç·ç§»å‹•</span>
                        <span>â˜‘å¾’æ­©</span>
                        <span>â˜‘å®¶è³ƒ</span>
                    </div>
                </div>
                <div class="ranking-list" id="rankingList">
                    <!-- å‹•çš„ã«ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆï¼ˆæœ€ä¸Šä½ã«é…ç½®ï¼‰ -->
    <div class="view-mode-toggle">
        <button class="view-mode-btn active" onclick="setViewMode('single', event)">å€‹åˆ¥</button>
        <button class="view-mode-btn" onclick="setViewMode('compare', event)">æ¯”è¼ƒ</button>
        <button class="view-mode-btn" onclick="setViewMode('ranking', event)">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>
    </div>
        
        <!-- ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆ -->
        <div class="bottom-sheet" id="bottomSheet">
            <div class="sheet-handle" onclick="toggleBottomSheet()"></div>
            <div class="sheet-content">
                <div class="view-modes">
                    <button class="view-btn active" onclick="setViewMode('single', event)">å€‹åˆ¥</button>
                    <button class="view-btn" onclick="setViewMode('compare', event)">æ¯”è¼ƒ</button>
                    <button class="view-btn" onclick="setViewMode('ranking', event)">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>
                </div>
                
                <div class="property-chips" id="propertyChips">
                    <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
                </div>
                
                <div class="area-info">
                    <div class="rent" id="mobileRent">å®¶è³ƒ: -</div>
                    <div class="stations" id="mobileStation">æœ€å¯„é§…: -</div>
                    <div class="total-time" id="mobileTotalTime">æœˆé–“ç·ç§»å‹•æ™‚é–“: -</div>
                    <div class="walk-time" id="mobileWalkTime">ã†ã¡å¾’æ­©æ™‚é–“: -</div>
                </div>
            </div>
        </div>
        
        <!-- ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— -->
        <div class="time-info" id="timeInfo"></div>
    </div>

    <script>
        // ã‚­ãƒ£ãƒ³ãƒã‚¹è¨­å®š
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºè¨­å®š
        function resizeCanvas() {
            const container = document.getElementById('container');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            if (container) {
                container.style.width = window.innerWidth + 'px';
                container.style.height = window.innerHeight + 'px';
            }
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        // ========================================
        // ãƒ‡ãƒ¼ã‚¿å®šç¾©ï¼ˆJSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å‹•çš„ã«èª­ã¿è¾¼ã¿ï¼‰
        // ========================================
        
        // ãƒ‡ãƒ¼ã‚¿æ ¼ç´å¤‰æ•°
        let destinations = [];
        let areas = [];
        
        // JSONãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§å†…éƒ¨å½¢å¼ã«å¤‰æ›
        async function loadDataFromJSON() {
            try {
                // JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸¦åˆ—ã§èª­ã¿è¾¼ã¿
                const [destResponse, propResponse] = await Promise.all([
                    fetch('./data/destinations.json'),
                    fetch('./data/properties.json')
                ]);
                
                if (!destResponse.ok || !propResponse.ok) {
                    throw new Error('ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                const destData = await destResponse.json();
                const propData = await propResponse.json();
                
                // destinationsé…åˆ—ã‚’æ§‹ç¯‰ï¼ˆç­‰é–“éš”ã«è§’åº¦ã‚’é…ç½®ï¼‰
                destinations = destData.destinations.map((dest, index) => ({
                    name: dest.name,
                    owner: dest.owner === 'both' ? 'shared' : dest.owner,
                    frequency: dest.monthly_frequency,
                    angle: (index * 360 / destData.destinations.length)
                }));
                
                // é‡è¤‡ã‚’é™¤å»ï¼ˆåŒã˜åå‰ã¨ä½æ‰€ã®ç‰©ä»¶ã‚’1ã¤ã ã‘æ®‹ã™ï¼‰
                const uniqueProperties = [];
                const seen = new Set();
                propData.properties.forEach(prop => {
                    const key = `${prop.name}_${prop.address}`;
                    if (!seen.has(key)) {
                        seen.add(key);
                        uniqueProperties.push(prop);
                    }
                });
                
                console.log(`ç‰©ä»¶ãƒ‡ãƒ¼ã‚¿: ${propData.properties.length}ä»¶ â†’ ${uniqueProperties.length}ä»¶ï¼ˆé‡è¤‡é™¤å»ï¼‰`);
                
                // areasé…åˆ—ã‚’æ§‹ç¯‰ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚‚ä¿æŒï¼‰
                areas = uniqueProperties.map((prop, index) => {
                    const area = {
                        originalIndex: index,  // å…ƒã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä¿æŒ
                        name: prop.name,
                        address: prop.address,
                        stations: formatStations(prop.stations),
                        rent: prop.rent,
                        routes: []
                    };
                    
                    // å„ç›®çš„åœ°ã¸ã®çµŒè·¯æƒ…å ±ã‚’å¤‰æ›
                    prop.routes.forEach(route => {
                        const destIndex = findDestinationIndex(route.destination);
                        if (destIndex !== -1) {
                            // walk_onlyã®å ´åˆã®å‡¦ç†
                            if (route.details && route.details.walk_only) {
                                area.routes.push({
                                    dest: destIndex,
                                    walk: route.details.walk_time || route.total_time,
                                    lines: [],
                                    transfer: 0,
                                    walk2: 0,
                                    total: route.total_time,
                                    rawDetails: route.details  // å…ƒãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
                                });
                            } else {
                                // é€šå¸¸ã®é›»è»Šåˆ©ç”¨çµŒè·¯
                                const trainSegments = extractTrainLines(route.details);
                                
                                // æ—§å½¢å¼ã®å ´åˆã®ä¹—æ›æ™‚é–“ï¼ˆæ–°å½¢å¼ã§ã¯å€‹åˆ¥ã«å«ã¾ã‚Œã‚‹ï¼‰
                                let totalTransfer = 0;
                                if (!route.details.trains?.[0]?.hasOwnProperty('from')) {
                                    totalTransfer = route.details.transfer_time || 0;
                                }
                                
                                area.routes.push({
                                    dest: destIndex,
                                    walk: route.details.walk_to_station || 0,
                                    lines: trainSegments,
                                    transfer: totalTransfer,
                                    walk2: route.details.walk_from_station || 0,
                                    total: route.total_time,
                                    rawDetails: route.details  // å…ƒãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
                                });
                            }
                        }
                    });
                    
                    return area;
                });
                
                // ã‚½ãƒ¼ãƒˆã‚’å®Ÿè¡Œã—ã¦ã‹ã‚‰UIã‚’æ›´æ–°
                sortedAreas = sortAreas();
                updatePropertySelector();
                
                // åˆæœŸé¸æŠã‚’ç¢ºå®Ÿã«è¨­å®š
                const allSelects = ['areaSelect', 'rankingAreaSelect', 'compareAreaSelect'];
                allSelects.forEach(id => {
                    const select = document.getElementById(id);
                    if (select && (select.value === '' || select.value === null)) {
                        select.value = '0';
                        console.log('ğŸ“Œ Initial selection set for', id, 'to 0');
                    }
                });
                
                updateAreaInfo();
                animate();
                
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
                alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚');
            }
        }
        
        // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ï¼šé§…æƒ…å ±ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatStations(stations) {
            if (!stations || stations.length === 0) return 'é§…æƒ…å ±ãªã—';
            // æœ€åˆã®é§…ã®ã¿ã‚’è¡¨ç¤ºï¼ˆãƒ¡ã‚¤ãƒ³ã®æœ€å¯„ã‚Šé§…ï¼‰
            const mainStation = stations[0];
            return `${mainStation.name} å¾’æ­©${mainStation.walk_time}åˆ†`;
        }
        
        // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ï¼šç›®çš„åœ°åã‹ã‚‰ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ¤œç´¢
        function findDestinationIndex(destName) {
            // destinationsé…åˆ—ã‹ã‚‰ç›´æ¥æ¤œç´¢ï¼ˆå®Œå…¨ä¸€è‡´ï¼‰
            const index = destinations.findIndex(d => d.name === destName);
            if (index === -1) {
                console.warn(`ç›®çš„åœ°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: "${destName}"`);
                console.log('åˆ©ç”¨å¯èƒ½ãªç›®çš„åœ°:', destinations.map(d => d.name));
            }
            return index;
        }
        
        // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ï¼šé›»è»Šæƒ…å ±ã‚’æŠ½å‡ºï¼ˆæ–°æ—§ä¸¡å½¢å¼ã«å¯¾å¿œï¼‰
        function extractTrainLines(details) {
            if (!details.trains || details.trains.length === 0) return [];
            
            // æ–°å½¢å¼ï¼ˆtransfer_afterã‚ã‚Šï¼‰ã®å ´åˆ
            if (details.trains[0] && details.trains[0].hasOwnProperty('from')) {
                // æ–°å½¢å¼: å„é›»è»Šã¨ä¹—æ›æƒ…å ±ã‚’å«ã‚€è©³ç´°ãƒ‡ãƒ¼ã‚¿
                const segments = [];
                details.trains.forEach((train, index) => {
                    segments.push({
                        name: train.line,
                        time: train.time,
                        from: train.from,
                        to: train.to
                    });
                    
                    // ä¹—æ›æƒ…å ±ãŒã‚ã‚Œã°è¿½åŠ 
                    if (train.transfer_after) {
                        segments.push({
                            type: 'transfer',
                            time: train.transfer_after.time,
                            from_line: train.line,
                            to_line: train.transfer_after.to_line
                        });
                    }
                });
                return segments;
            } else {
                // æ—§å½¢å¼: ã‚·ãƒ³ãƒ—ãƒ«ãªé…åˆ—
                return details.trains.map(train => ({
                    name: train.line,
                    time: train.time
                }));
            }
        }
        
        // ã‚½ãƒ¼ãƒˆå‡¦ç†
        function sortAreas() {
            if (areas.length === 0) {
                console.log('sortAreas: areas is empty');
                return [];
            }
            
            console.log('sortAreas called. currentSortOrder:', currentSortOrder);
            console.log('areas before sort:', areas.map(a => a.name));
            
            // ãƒ«ãƒ•ã‚©ãƒ³ãƒ—ãƒ­ã‚°ãƒ¬ï¼ˆæœ€åˆã®ç‰©ä»¶ï¼‰ã‚’é™¤ã„ã¦ä¸¦ã³æ›¿ãˆ
            const firstProperty = areas[0];
            const otherProperties = areas.slice(1);
            
            // ã‚½ãƒ¼ãƒˆå®Ÿè¡Œ
            switch(currentSortOrder) {
                case 'time_desc':
                    // æœˆé–“ç·ç§»å‹•æ™‚é–“ã®çŸ­ã„é †ï¼ˆæ˜‡é †ï¼‰
                    otherProperties.sort((a, b) => {
                        const { totalTime: timeA } = calculateMonthlyTimes(a);
                        const { totalTime: timeB } = calculateMonthlyTimes(b);
                        console.log(`Comparing ${a.name}(${timeA}) vs ${b.name}(${timeB}) = ${timeA - timeB}`);
                        return timeA - timeB;
                    });
                    break;
                case 'walk_desc':
                    // å¾’æ­©æ™‚é–“ã®çŸ­ã„é †ï¼ˆæ˜‡é †ï¼‰
                    otherProperties.sort((a, b) => {
                        const { totalWalkTime: walkA } = calculateMonthlyTimes(a);
                        const { totalWalkTime: walkB } = calculateMonthlyTimes(b);
                        return walkA - walkB;
                    });
                    break;
                case 'rent_asc':
                    // å®¶è³ƒã®å®‰ã„é †
                    otherProperties.sort((a, b) => {
                        const rentA = parseRent(a.rent);
                        const rentB = parseRent(b.rent);
                        console.log(`Comparing rent: ${a.name}(${rentA}) vs ${b.name}(${rentB}) = ${rentA - rentB}`);
                        return rentA - rentB;
                    });
                    break;
            }
            
            // ãƒ«ãƒ•ã‚©ãƒ³ãƒ—ãƒ­ã‚°ãƒ¬ã‚’æœ€åˆã«é…ç½®ã—ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä¿æŒ
            sortedAreas = [firstProperty, ...otherProperties];
            
            console.log('ğŸ‰ Sort completed. Order:', sortedAreas.map((a, i) => `${i+1}.${a.name}`).slice(0, 5).join(', '), '...');
            console.log('ğŸ‰ Total:', sortedAreas.length, 'properties');
            
            // originalIndexãŒå¤±ã‚ã‚Œã¦ã„ãªã„ã‹ç¢ºèª
            sortedAreas.forEach((area, newIndex) => {
                if (area.originalIndex === undefined) {
                    console.error('originalIndex is missing for area:', area.name);
                }
            });
            
            return sortedAreas;
        }
        
        // ã‚»ãƒ¬ã‚¯ã‚¿ã‚’å‹•çš„ã«æ›´æ–°
        function updatePropertySelector() {
            const select = document.getElementById('areaSelect');
            const rankingSelect = document.getElementById('rankingAreaSelect');
            const compareSelect = document.getElementById('compareAreaSelect');
            if (!select && !rankingSelect && !compareSelect) return;
            
            // ã‚½ãƒ¼ãƒˆæ¸ˆã¿ãƒªã‚¹ãƒˆãŒç©ºã®å ´åˆã¯å…ƒã®areasã‚’ä½¿ç”¨
            const displayAreas = sortedAreas.length > 0 ? sortedAreas : areas;
            console.log('ğŸ“¦ updatePropertySelector: Using', displayAreas.length, 'areas');
            console.log('ğŸ“¦ Display order:', displayAreas.map(a => a.name).slice(0, 5), '...');
            
            const optionsHtml = displayAreas.map((area, index) => 
                `<option value="${index}">${area.name}</option>`
            ).join('');
            
            console.log('ğŸ“ Creating dropdown HTML with:', displayAreas.slice(0, 3).map(a => a.name));
            
            // ç¾åœ¨ã®é¸æŠã•ã‚Œã¦ã„ã‚‹ç‰©ä»¶ã®originalIndexã‚’ä¿å­˜
            let currentAreaIndex = selectedAreaIndex;
            console.log('ğŸ” Current selectedAreaIndex:', currentAreaIndex);
            console.log('ğŸ” DisplayAreas originalIndexes:', displayAreas.map(a => ({name: a.name, originalIndex: a.originalIndex})).slice(0, 3));
            
            // HTMLã‚’æ›´æ–°
            if (select) {
                const previousValue = select.value;
                select.innerHTML = optionsHtml;
                // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ç‰©ä»¶ã‚’æ–°ã—ã„ã‚½ãƒ¼ãƒˆé †ã§è¦‹ã¤ã‘ã‚‹
                const newIndex = displayAreas.findIndex(area => 
                    (area.originalIndex !== undefined ? area.originalIndex : areas.indexOf(area)) === currentAreaIndex
                );
                console.log('ğŸ” Individual dropdown: previousValue=', previousValue, 'newIndex=', newIndex);
                if (newIndex !== -1) {
                    select.value = newIndex;
                } else {
                    select.value = '0'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æœ€åˆã‚’é¸æŠï¼ˆæ–‡å­—åˆ—ã¨ã—ã¦è¨­å®šï¼‰
                }
                console.log('ğŸ” Individual dropdown after update: value=', select.value);
            }
            if (rankingSelect) {
                const previousValue = rankingSelect.value;
                rankingSelect.innerHTML = optionsHtml;
                const newIndex = displayAreas.findIndex(area => 
                    (area.originalIndex !== undefined ? area.originalIndex : areas.indexOf(area)) === currentAreaIndex
                );
                console.log('ğŸ” Ranking dropdown: previousValue=', previousValue, 'newIndex=', newIndex);
                if (newIndex !== -1) {
                    rankingSelect.value = newIndex.toString();
                } else {
                    rankingSelect.value = '0';
                }
                console.log('ğŸ” Ranking dropdown after update: value=', rankingSelect.value);
            }
            if (compareSelect) {
                const previousValue = compareSelect.value;
                compareSelect.innerHTML = optionsHtml;
                const newIndex = displayAreas.findIndex(area => 
                    (area.originalIndex !== undefined ? area.originalIndex : areas.indexOf(area)) === currentAreaIndex
                );
                console.log('ğŸ” Compare dropdown: previousValue=', previousValue, 'newIndex=', newIndex);
                if (newIndex !== -1) {
                    compareSelect.value = newIndex.toString();
                } else {
                    compareSelect.value = '0';
                }
                console.log('ğŸ” Compare dropdown after update: value=', compareSelect.value);
            }
            
            // ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®ãƒãƒƒãƒ—ã‚‚æ›´æ–°
            updateMobileChips();
        }
        
        // ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒãƒƒãƒ—ã‚’å‹•çš„ç”Ÿæˆ
        function updateMobileChips() {
            const container = document.getElementById('propertyChips');
            if (!container) return;
            
            const displayAreas = sortedAreas.length > 0 ? sortedAreas : areas;
            
            // æœ€åˆã®5ä»¶ã®ã¿ãƒãƒƒãƒ—ã¨ã—ã¦è¡¨ç¤º
            container.innerHTML = displayAreas.slice(0, 5).map((area, index) => 
                `<div class="property-chip ${index === 0 ? 'active' : ''}" 
                      onclick="selectPropertyMobile(${index})">
                    ${area.name.split(' ')[0]}
                </div>`
            ).join('');
        }
        
        // ========================================
        // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        // ========================================
        function parseRent(rentString) {
            if (typeof rentString === 'number') return rentString;
            // "280,000å††" -> 280000
            const cleaned = rentString.replace(/[^0-9]/g, '');
            return parseInt(cleaned) || 0;
        }
        
        // ========================================
        // çŠ¶æ…‹ç®¡ç†
        // ========================================
        let selectedAreaIndex = 0;
        let currentViewMode = 'single';
        let currentSortOrder = 'time_desc';  // ã‚½ãƒ¼ãƒˆé †ã‚’è¿½åŠ 
        let sortedAreas = [];  // ã‚½ãƒ¼ãƒˆæ¸ˆã¿é…åˆ—ã‚’ä¿æŒ
        let zoomScale = 2.0;  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’2.0ï¼ˆ200%ï¼‰ã«å¤‰æ›´
        let offsetX = 0;
        let offsetY = 0;
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let lastOffsetX = 0;
        let lastOffsetY = 0;
        let bottomSheetExpanded = false;
        // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆç”¨ã®çŠ¶æ…‹å¤‰æ•°
        let lastTouchX = 0;
        let lastTouchY = 0;
        let initialPinchDistance = 0;
        let lastZoomScale = 0;
        let pinchStartX = 0;
        let pinchStartY = 0;
        let isPinching = false;
        
        // ========================================
        // ãƒ¡ã‚¤ãƒ³æç”»é–¢æ•°
        // ========================================
        function drawBackground() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ç´”ç²‹ãªé»’èƒŒæ™¯
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ç¾åœ¨ã®ç‰©ä»¶ã®æœ€å¤§ç§»å‹•æ™‚é–“ã‚’å–å¾—ï¼ˆå…ƒã®é…åˆ—ã‹ã‚‰ç›´æ¥å–å¾—ï¼‰
            const currentArea = areas[selectedAreaIndex];
            let maxTime = 0;
            currentArea.routes.forEach(route => {
                if (route.total > maxTime) {
                    maxTime = route.total;
                }
            });
            
            // 10åˆ†å˜ä½ã§åˆ‡ã‚Šä¸Šã’ï¼ˆæœ€å°40åˆ†ã€æœ€å¤§80åˆ†ï¼‰
            const maxCircleTime = Math.max(40, Math.min(80, Math.ceil(maxTime / 10) * 10 + 10));
            
            // å¤‰æ›ã‚’é©ç”¨
            ctx.save();
            ctx.translate(canvas.width / 2 + offsetX, canvas.height / 2 + offsetY);
            ctx.scale(zoomScale, zoomScale);
            
            // åŒå¿ƒå††ï¼ˆæ™‚é–“ã®ç›®å®‰ï¼‰
            for (let minutes = 5; minutes <= maxCircleTime; minutes += 5) {
                const radius = minutes * 10; // ã‚¹ã‚±ãƒ¼ãƒ«èª¿æ•´ï¼ˆ30åˆ†ãŒç”»é¢ã®ç«¯ã«æ¥ã‚‹ã‚ˆã†ã«ï¼‰
                
                // 10åˆ†åˆ»ã¿ã¯å®Ÿç·šã€5åˆ†åˆ»ã¿ã¯ç‚¹ç·š
                if (minutes % 10 === 0) {
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.15)'; // å°‘ã—æ¿ƒã
                    ctx.setLineDash([]); // å®Ÿç·š
                } else {
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
                    ctx.setLineDash([5, 5]); // ç‚¹ç·š
                }
                
                ctx.beginPath();
                ctx.arc(0, 0, radius, 0, Math.PI * 2);
                ctx.stroke();
                
                // 10åˆ†åˆ»ã¿ã®ã¿ãƒ©ãƒ™ãƒ«è¡¨ç¤ºï¼ˆ4æ–¹å‘ï¼‰
                if (minutes % 10 === 0) {
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                    ctx.font = '10px sans-serif'; // ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å°ã•ã
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    
                    // å³
                    ctx.fillText(minutes + 'åˆ†', radius, 0);
                    // å·¦
                    ctx.fillText(minutes + 'åˆ†', -radius, 0);
                    // ä¸Š
                    ctx.save();
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'bottom';
                    ctx.fillText(minutes + 'åˆ†', 0, -radius);
                    ctx.restore();
                    // ä¸‹
                    ctx.save();
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'top';
                    ctx.fillText(minutes + 'åˆ†', 0, radius);
                    ctx.restore();
                }
            }
            
            ctx.setLineDash([]);
            
            // æ”¾å°„çŠ¶ã®ç·šï¼ˆæ–¹å‘ã®ç›®å®‰ï¼‰- æœ€å¤§å††ã¾ã§å»¶é•·
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
            const maxRadius = maxCircleTime * 10 + 50; // ã‚¹ã‚±ãƒ¼ãƒ«èª¿æ•´
            for (let i = 0; i < 12; i++) {
                const angle = (i * 30) * Math.PI / 180;
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.lineTo(Math.cos(angle) * maxRadius, Math.sin(angle) * maxRadius);
                ctx.stroke();
            }
            
            ctx.restore();
        }
        
        function drawElements() {
            // å€‹åˆ¥ãƒ“ãƒ¥ãƒ¼ä»¥å¤–ã§ã¯å®Ÿè¡Œã—ãªã„
            if (currentViewMode !== 'single') return;
            
            // æ—¢å­˜ã®è¦ç´ ã‚’å‰Šé™¤
            document.querySelectorAll('.destination-marker, .destination-label, .home-marker, .route-segment').forEach(el => el.remove());
            
            const centerX = canvas.width / 2 + offsetX;
            const centerY = canvas.height / 2 + offsetY;
            const scale = zoomScale;
            
            // ãƒ›ãƒ¼ãƒ ãƒãƒ¼ã‚«ãƒ¼ï¼ˆä¸­å¿ƒï¼‰
            const homeMarker = document.createElement('div');
            homeMarker.className = 'home-marker';
            homeMarker.style.left = centerX + 'px';
            homeMarker.style.top = centerY + 'px';
            document.getElementById('container').appendChild(homeMarker);
            
            // ç›®çš„åœ°ãƒãƒ¼ã‚«ãƒ¼ã¨çµŒè·¯ï¼ˆå…ƒã®é…åˆ—ã‹ã‚‰ç›´æ¥å–å¾—ï¼‰
            const area = areas[selectedAreaIndex];
            
            area.routes.forEach((route) => {
                const dest = destinations[route.dest];
                const time = route.total;
                
                // archiveç‰ˆã®è¨ˆç®—æ–¹æ³•ã‚’æ­£ç¢ºã«å†ç¾ï¼ˆã‚¹ã‚±ãƒ¼ãƒ«èª¿æ•´ï¼‰
                const angle = dest.angle * Math.PI / 180;
                const distance = time * 10; // æ™‚é–“è·é›¢ã®è¨ˆç®—ï¼ˆ30åˆ†åœå†…ãŒé©åˆ‡ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚¹ã‚±ãƒ¼ãƒ«ï¼‰
                
                const totalDistance = distance * scale;
                const x = centerX + Math.cos(angle) * totalDistance;
                const y = centerY + Math.sin(angle) * totalDistance;
                
                // çµŒè·¯ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’æç”»ï¼ˆãƒãƒ¼ã‚«ãƒ¼ã‚ˆã‚Šå…ˆã«æç”»ã—ã¦ä¸‹å±¤ã«ï¼‰
                drawRouteSegments(route, dest, angle, totalDistance, centerX, centerY);
                
                // ãƒãƒ¼ã‚«ãƒ¼ï¼ˆborderã‚’å«ã‚ãŸå…¨ä½“ã‚µã‚¤ã‚ºã¯20pxï¼‰
                const marker = document.createElement('div');
                marker.className = 'destination-marker';
                if (dest.owner === 'partner') marker.classList.add('partner');
                if (dest.owner === 'shared' || dest.owner === 'both') marker.classList.add('shared');
                
                // ãƒãƒ¼ã‚«ãƒ¼ã®ä¸­å¿ƒã‚’ç·šåˆ†ã®çµ‚ç«¯ã«æ­£ç¢ºã«é…ç½®
                marker.style.left = x + 'px';
                marker.style.top = y + 'px';
                
                // ãƒ©ãƒ™ãƒ«
                const label = document.createElement('div');
                label.className = 'destination-label';
                label.textContent = dest.name;
                label.style.left = x + 'px';
                label.style.top = y + 'px';
                
                // ãƒãƒ¼ã‚«ãƒ¼ã®ãƒ›ãƒãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
                marker.onmouseover = (e) => showTimeInfo(e, route, dest);
                marker.onmouseout = hideTimeInfo;
                
                document.getElementById('container').appendChild(marker);
                document.getElementById('container').appendChild(label);
            });
        }
        
        function drawRouteSegments(route, dest, angle, totalDistance, centerX, centerY) {
            let segments = [];
            
            // ãƒãƒ¼ã‚«ãƒ¼ã®åŠå¾„ã‚’è€ƒæ…®ã—ãŸç·šåˆ†ã®çµ‚ç«¯ä½ç½®
            const markerRadius = 10; // ãƒãƒ¼ã‚«ãƒ¼ã®å®Ÿéš›ã®åŠå¾„ï¼ˆ16px/2 + border 2pxï¼‰
            const lineEndDistance = totalDistance - markerRadius;
            
            // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®æ§‹ç¯‰
            if (!route.lines || route.lines.length === 0) {
                // å¾’æ­©ã®ã¿ã¾ãŸã¯ãƒ‡ãƒ¼ã‚¿ä¸è¶³ã®å ´åˆ
                segments.push({type: 'walk', duration: route.total, color: 'walk'});
            } else {
                // é§…ã¾ã§ã®å¾’æ­©
                if (route.walk > 0) {
                    segments.push({type: 'walk', duration: route.walk, color: 'walk'});
                }
                
                // æ–°å½¢å¼ãƒã‚§ãƒƒã‚¯ï¼ˆä¹—æ›æƒ…å ±ãŒå€‹åˆ¥ã«å«ã¾ã‚Œã¦ã„ã‚‹ï¼‰
                const hasDetailedTransfers = route.lines.some(segment => segment.type === 'transfer');
                
                if (hasDetailedTransfers) {
                    // æ–°å½¢å¼: é›»è»Šã¨ä¹—æ›ãŒäº¤äº’ã«å…¥ã£ã¦ã„ã‚‹
                    route.lines.forEach(segment => {
                        if (segment.type === 'transfer') {
                            segments.push({
                                type: 'transfer',
                                duration: segment.time,
                                color: 'transfer',
                                from_line: segment.from_line,
                                to_line: segment.to_line
                            });
                        } else {
                            segments.push({
                                type: 'train',
                                duration: segment.time,
                                color: 'train',
                                line: segment.name
                            });
                        }
                    });
                } else {
                    // æ—§å½¢å¼: é›»è»Šã®é…åˆ—ã¨ç·ä¹—æ›æ™‚é–“
                    route.lines.forEach((line, index) => {
                        segments.push({
                            type: 'train',
                            duration: line.time,
                            color: 'train',
                            line: line.name
                        });
                        
                        // æœ€å¾Œã®é›»è»Šä»¥å¤–ã®å¾Œã«ä¹—æ›ã‚’æŒ¿å…¥
                        if (index < route.lines.length - 1 && route.transfer > 0) {
                            // è¤‡æ•°ä¹—æ›ã®å ´åˆã¯å‡ç­‰å‰²ã‚Šï¼ˆä»®ï¼‰
                            const transferTime = route.transfer / (route.lines.length - 1);
                            segments.push({
                                type: 'transfer',
                                duration: transferTime,
                                color: 'transfer'
                            });
                        }
                    });
                }
                
                // é§…ã‹ã‚‰ã®å¾’æ­©
                if (route.walk2 > 0) {
                    segments.push({type: 'walk', duration: route.walk2, color: 'walk'});
                }
            }
            
            // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’DOMè¦ç´ ã¨ã—ã¦æç”»
            let currentPos = 0;
            const gap = 2;
            const activeSegments = segments.filter(s => s.duration > 0);
            const totalGaps = Math.max(0, activeSegments.length - 1) * gap;
            const adjustedTotalDistance = lineEndDistance - totalGaps; // ãƒãƒ¼ã‚«ãƒ¼åŠå¾„ã¨ã‚®ãƒ£ãƒƒãƒ—ã‚’è€ƒæ…®
            
            segments.forEach((segment, idx) => {
                if (segment.duration > 0) {
                    const segmentLength = (segment.duration / route.total) * adjustedTotalDistance;
                    const startX = centerX + Math.cos(angle) * currentPos;
                    const startY = centerY + Math.sin(angle) * currentPos;
                    
                    const div = document.createElement('div');
                    div.className = `route-segment ${segment.color}`;
                    
                    // å…±æœ‰è·¯ç·šã¯é’ç³»ã®è‰²ã§çµ±ä¸€ï¼ˆç·‘è‰²ã‚’å»ƒæ­¢ï¼‰
                    if (dest.owner === 'shared' && segment.type === 'train') {
                        // sharedã‚¯ãƒ©ã‚¹ã¯è¿½åŠ ã›ãšã€é€šå¸¸ã®é›»è»Šã®è‰²ã‚’ä½¿ç”¨
                        div.style.opacity = '1';
                    }
                    
                    div.style.left = startX + 'px';
                    div.style.top = startY + 'px';
                    div.style.width = Math.max(segmentLength, 5) + 'px';
                    div.style.transform = `rotate(${angle}rad) translateY(-4px)`;
                    
                    // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—
                    if (segment.type === 'walk') {
                        div.title = `å¾’æ­©: ${segment.duration}åˆ†`;
                    } else if (segment.type === 'train') {
                        div.title = `${segment.line}: ${segment.duration}åˆ†`;
                    } else {
                        div.title = `ä¹—ã‚Šæ›ãˆ: ${segment.duration}åˆ†`;
                    }
                    
                    document.getElementById('container').appendChild(div);
                    
                    currentPos += segmentLength;
                    // æœ€å¾Œã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆä»¥å¤–ã¯ã‚®ãƒ£ãƒƒãƒ—ã‚’è¿½åŠ 
                    const activeIndex = activeSegments.indexOf(segment);
                    if (activeIndex < activeSegments.length - 1) {
                        currentPos += gap;
                    }
                }
            });
        }
        
        function showTimeInfo(e, route, dest) {
            const info = document.getElementById('timeInfo');
            let content = `<strong>${dest.name}</strong><br>`;
            content += `åˆè¨ˆ: ${route.total}åˆ†<br><br>`;
            
            if (route.lines.length === 0) {
                content += `å¾’æ­©ã®ã¿: ${route.walk}åˆ†`;
            } else {
                content += `å¾’æ­©ï¼ˆå®¶â†’é§…ï¼‰: ${route.walk}åˆ†<br>`;
                route.lines.forEach((line, i) => {
                    content += `${line.name}: ${line.time}åˆ†<br>`;
                    if (i < route.lines.length - 1 && route.transfer) {
                        content += `ä¹—ã‚Šæ›ãˆ: ${route.transfer}åˆ†<br>`;
                    }
                });
                if (route.walk2 > 0) {
                    content += `å¾’æ­©ï¼ˆé§…â†’ç›®çš„åœ°ï¼‰: ${route.walk2}åˆ†`;
                }
            }
            
            info.innerHTML = content;
            info.style.display = 'block';
            info.style.left = e.pageX + 15 + 'px';
            info.style.top = e.pageY + 15 + 'px';
        }
        
        function hideTimeInfo() {
            document.getElementById('timeInfo').style.display = 'none';
        }
        
        // ========================================
        // UIåˆ¶å¾¡
        // ========================================
        function setViewMode(mode, event) {
            currentViewMode = mode;
            
            // ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆæ™‚ã«ã‚½ãƒ¼ãƒˆé †ã‚’åŒæœŸ
            setTimeout(() => {
                const sortSelect = document.getElementById('sortOrder');
                const rankingSortSelect = document.getElementById('rankingSortOrder');
                const compareSortSelect = document.getElementById('compareSortOrder');
                
                // ç¾åœ¨ã®ã‚½ãƒ¼ãƒˆé †ã‚’æ–°ã—ã„ãƒ“ãƒ¥ãƒ¼ã®ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã«åæ˜ 
                if (sortSelect) sortSelect.value = currentSortOrder;
                if (rankingSortSelect) rankingSortSelect.value = currentSortOrder;
                if (compareSortSelect) compareSortSelect.value = currentSortOrder;
            }, 100);
            
            // æ—¢å­˜ã®DOMè¦ç´ ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            document.querySelectorAll('.destination-marker, .destination-label, .home-marker, .route-segment').forEach(el => el.remove());
            
            // ãƒ“ãƒ¥ãƒ¼ã‚’åˆ‡ã‚Šæ›¿ãˆ
            document.querySelectorAll('.view-container').forEach(v => v.classList.remove('active'));
            document.getElementById(mode + 'View').classList.add('active');
            
            // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('.view-mode-btn').forEach(btn => btn.classList.remove('active'));
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªã‚¢
            if (ctx) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            
            // å„ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
            if (mode === 'compare') {
                updateCompareView();
            } else if (mode === 'ranking') {
                updateRankingView();
            } else if (mode === 'single') {
                animate();
            }
            
            // CRITICAL FIX: ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚»ãƒ¬ã‚¯ã‚¿ã‚’æ›´æ–°ï¼ˆã‚½ãƒ¼ãƒˆæ¸ˆã¿é…åˆ—ã‚’åæ˜ ï¼‰- ãƒ“ãƒ¥ãƒ¼æ›´æ–°å¾Œã«å®Ÿè¡Œ
            updatePropertySelector();
            
            // ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆæ™‚ã«ç¢ºå®Ÿã«é¸æŠå€¤ã‚’è¨­å®š
            let targetSelect;
            if (mode === 'ranking') {
                targetSelect = document.getElementById('rankingAreaSelect');
            } else if (mode === 'compare') {
                targetSelect = document.getElementById('compareAreaSelect');
            } else {
                targetSelect = document.getElementById('areaSelect');
            }
            
            if (targetSelect && (targetSelect.value === '' || targetSelect.value === null)) {
                targetSelect.value = '0';
                console.log('ğŸ¯ View switch: Set default selection for', mode, 'view');
            }
            
            // CRITICAL FIX: è¿½åŠ ã®é…å»¶æ›´æ–°ã§ç¢ºå®Ÿã«åŒæœŸ
            setTimeout(() => {
                updatePropertySelector();
                console.log('ğŸ”„ View switch: Dropdowns synchronized');
            }, 50);
        }
        
        function calculateMonthlyTimes(area) {
            let totalTime = 0;
            let totalWalkTime = 0;
            
            area.routes.forEach((route, index) => {
                const dest = destinations[route.dest];
                const frequency = dest.frequency || 1;
                
                // å¾€å¾©ã§2å€
                totalTime += route.total * frequency * 2;
                
                // å¾’æ­©æ™‚é–“ã®è¨ˆç®—
                const walkTime = route.walk + (route.walk2 || 0);
                totalWalkTime += walkTime * frequency * 2;
            });
            
            return { totalTime, totalWalkTime };
        }
        
        function updateSelectedArea() {
            // ç¾åœ¨ã®ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦æ­£ã—ã„ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‹ã‚‰å€¤ã‚’å–å¾—
            let selectElement;
            if (currentViewMode === 'ranking') {
                selectElement = document.getElementById('rankingAreaSelect');
            } else if (currentViewMode === 'compare') {
                selectElement = document.getElementById('compareAreaSelect');
            } else {
                selectElement = document.getElementById('areaSelect');
            }
            
            if (!selectElement || selectElement.value === '') {
                console.log('âš ï¸ No select element or empty value in', currentViewMode, 'view');
                return;
            }
            
            const selectIndex = parseInt(selectElement.value);
            const displayAreas = sortedAreas.length > 0 ? sortedAreas : areas;
            
            // ã‚½ãƒ¼ãƒˆå¾Œã®é…åˆ—ã‹ã‚‰ç‰©ä»¶ã‚’å–å¾—ã—ã€ãã®å…ƒã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä¿æŒ
            const selectedArea = displayAreas[selectIndex];
            if (!selectedArea) {
                console.log('âš ï¸ No area found at index', selectIndex);
                return;
            }
            
            selectedAreaIndex = selectedArea.originalIndex !== undefined ? selectedArea.originalIndex : selectIndex;
            console.log('âœ… Selected area:', selectedArea.name, 'originalIndex:', selectedAreaIndex);
            
            updateAreaInfo();
            animate();
        }
        
        function updateSortOrder() {
            // ã™ã¹ã¦ã®ãƒ“ãƒ¥ãƒ¼ã®ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯
            const sortSelect = document.getElementById('sortOrder');
            const rankingSortSelect = document.getElementById('rankingSortOrder');
            const compareSortSelect = document.getElementById('compareSortOrder');
            
            // ç¾åœ¨ã®ãƒ“ãƒ¥ãƒ¼ã«åŸºã¥ã„ã¦æ­£ã—ã„ã‚»ãƒ¬ã‚¯ãƒˆã‹ã‚‰å€¤ã‚’å–å¾—
            if (currentViewMode === 'ranking' && rankingSortSelect) {
                currentSortOrder = rankingSortSelect.value;
            } else if (currentViewMode === 'compare' && compareSortSelect) {
                currentSortOrder = compareSortSelect.value;
            } else if (sortSelect) {
                currentSortOrder = sortSelect.value;
            }
            
            console.log('ğŸ”„ updateSortOrder called from', currentViewMode, 'view. New sort order:', currentSortOrder);
            console.log('ğŸ“ Current view mode:', currentViewMode);
            console.log('ğŸ“ Sort dropdowns found:', {
                individual: !!sortSelect,
                ranking: !!rankingSortSelect,
                compare: !!compareSortSelect
            });
            
            // ã™ã¹ã¦ã®ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’åŒæœŸ
            if (sortSelect) sortSelect.value = currentSortOrder;
            if (rankingSortSelect) rankingSortSelect.value = currentSortOrder;
            if (compareSortSelect) compareSortSelect.value = currentSortOrder;
            
            sortedAreas = sortAreas();
            console.log('ğŸ“Š Sorted order:', sortedAreas.map((a, i) => {
                const times = calculateMonthlyTimes(a);
                const rent = parseRent(a.rent);
                return `${i+1}. ${a.name} (Â¥${rent.toLocaleString()}, ${Math.round(times.totalTime)}åˆ†/æœˆ, å¾’æ­©${Math.round(times.totalWalkTime)}åˆ†/æœˆ)`;
            }));
            
            // CRITICAL FIX: Update property selectors FIRST
            updatePropertySelector();
            
            // å¼·åˆ¶çš„ã«å…¨ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
            updateAreaInfo();
            if (currentViewMode === 'ranking') {
                console.log('ğŸ† FORCING ranking view update with new sort order:', currentSortOrder);
                updateRankingView(); // Direct call instead of updateRanking() for immediate refresh
            } else if (currentViewMode === 'compare') {
                console.log('ğŸ“Š FORCING compare view update with new sort order:', currentSortOrder);
                updateCompareView();
            }
            
            // CRITICAL FIX: Update property selectors AGAIN after view updates to ensure they stick
            setTimeout(() => {
                updatePropertySelector();
                console.log('ğŸ”„ Dropdown re-synchronized after view update');
            }, 50);
            
            animate();
        }
        
        function updateAreaInfo() {
            // å…ƒã®é…åˆ—ã‹ã‚‰ç›´æ¥å–å¾—ï¼ˆselectedAreaIndexã¯å…ƒã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼‰
            const area = areas[selectedAreaIndex];
            const { totalTime, totalWalkTime } = calculateMonthlyTimes(area);
            
            // æ™‚é–“ã‚’èª­ã¿ã‚„ã™ã„å½¢å¼ã«
            const formatTime = (minutes) => {
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return hours > 0 ? `${hours}æ™‚é–“${mins}åˆ†` : `${mins}åˆ†`;
            };
            
            // ç›®çš„åœ°ã‚’æŒ‡å®šé †åºã§ä¸¦ã¹ã‚‹ï¼ˆè‡³å–„é¤¨ã€æ±äº¬ã‚¢ãƒ¡ãƒªã‚«ãƒ³ã‚¯ãƒ©ãƒ–ã€Yawaraã€ãã®å¾Œã¯é »åº¦é †ï¼‰
            const priorityOrder = ['è‡³å–„é¤¨', 'æ±äº¬ã‚¢ãƒ¡ãƒªã‚«ãƒ³ã‚¯ãƒ©ãƒ–', 'Yawaraï¼ˆæ¸‹è°·ï¼‰'];
            
            const destinationsWithFreq = destinations.map((dest, index) => ({
                name: dest.name,
                index: index,
                frequency: dest.frequency,
                owner: dest.owner
            })).sort((a, b) => {
                // å„ªå…ˆé †ä½ãƒªã‚¹ãƒˆã«ã‚ã‚‹å ´åˆã¯ãã®é †åºã§
                const aPriority = priorityOrder.indexOf(a.name);
                const bPriority = priorityOrder.indexOf(b.name);
                
                if (aPriority !== -1 && bPriority !== -1) {
                    return aPriority - bPriority;
                }
                if (aPriority !== -1) return -1;
                if (bPriority !== -1) return 1;
                
                // ãã‚Œä»¥å¤–ã¯é »åº¦é †
                return b.frequency - a.frequency;
            });
            
            let destinationsList = '<div class="destinations-list">';
            destinationsList += '<div class="destinations-list-title">ä¸»è¦ç›®çš„åœ°ã¸ã®ç§»å‹•æ™‚é–“</div>';
            destinationsWithFreq.forEach(dest => {
                const route = area.routes[dest.index];
                const ownerIcon = dest.owner === 'you' ? 'ğŸ”´' : dest.owner === 'partner' ? 'ğŸŸ¢' : 'ğŸŸ¡';
                destinationsList += `
                    <div class="destination-item">
                        <span class="name">${ownerIcon} ${dest.name}:</span>
                        <span class="time">${route.total}åˆ†</span>
                    </div>
                `;
            });
            destinationsList += '</div>';
            
            // å…¨ãƒ“ãƒ¥ãƒ¼ã®ç‰©ä»¶æƒ…å ±ã‚«ãƒ¼ãƒ‰ã‚’åŒã˜å†…å®¹ã§æ›´æ–°
            const areaInfoElements = [
                document.getElementById('areaInfo'),
                document.getElementById('rankingAreaInfo'), 
                document.getElementById('compareAreaInfo')
            ];
            
            areaInfoElements.forEach(info => {
                if (info) {
                    info.innerHTML = `
                        <div class="rent">å®¶è³ƒ: ${area.rent}</div>
                        <div class="stations">æœ€å¯„é§…: ${area.stations}</div>
                        <div class="total-time">æœˆé–“ç·ç§»å‹•æ™‚é–“: ${formatTime(Math.round(totalTime))}</div>
                        <div class="walk-time">ã†ã¡å¾’æ­©æ™‚é–“: ${formatTime(Math.round(totalWalkTime))}</div>
                        ${destinationsList}
                    `;
                }
            });
            
            // ãƒ¢ãƒã‚¤ãƒ«ç”¨
            if (document.getElementById('mobileRent')) {
                document.getElementById('mobileRent').textContent = `å®¶è³ƒ: ${area.rent}`;
                document.getElementById('mobileStation').textContent = `æœ€å¯„é§…: ${area.stations}`;
                document.getElementById('mobileTotalTime').textContent = `æœˆé–“ç·ç§»å‹•æ™‚é–“: ${formatTime(Math.round(totalTime))}`;
                document.getElementById('mobileWalkTime').textContent = `ã†ã¡å¾’æ­©æ™‚é–“: ${formatTime(Math.round(totalWalkTime))}`;
            }
        }
        
        function updateCompareView() {
            const compareContent = document.getElementById('compareContent');
            
            // ç‰©ä»¶æƒ…å ±ã‚«ãƒ¼ãƒ‰ã¯ updateAreaInfo ã§æ›´æ–°ã•ã‚Œã‚‹
            updateAreaInfo();
            
            // å…¨ç›®çš„åœ°ã‚’é »åº¦é †ã«ã‚½ãƒ¼ãƒˆ
            const importantDestinations = destinations
                .map((dest, index) => ({ 
                    dest, 
                    index, 
                    frequency: dest.frequency 
                }))
                .sort((a, b) => b.frequency - a.frequency);
            
            let html = '';
            
            importantDestinations.forEach(destInfo => {
                const dest = destInfo.dest;
                const destIndex = destInfo.index;
                
                // å„ç‰©ä»¶ã®æ™‚é–“ã‚’å–å¾—ï¼ˆã‚½ãƒ¼ãƒˆæ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ï¼‰
                const displayAreas = sortedAreas.length > 0 ? sortedAreas : areas;
                const times = displayAreas.map(area => {
                    const route = area.routes[destIndex];
                    return { area, route, total: route.total };
                });
                
                // æœ€çŸ­æ™‚é–“ã‚’è¦‹ã¤ã‘ã‚‹
                const minTime = Math.min(...times.map(t => t.total));
                const maxTime = 45; // æœ€å¤§45åˆ†ã®ã‚¹ã‚±ãƒ¼ãƒ«
                
                // é »åº¦ã®è¡¨ç¤ºå½¢å¼
                const freqText = destInfo.frequency >= 4.4 ? 
                    `é€±${Math.round(destInfo.frequency / 4.4)}å›` : 
                    `æœˆ${Math.round(destInfo.frequency)}å›`;
                
                html += `
                    <div class="destination-comparison">
                        <div class="destination-header">
                            <div class="destination-name">${dest.name}</div>
                            <div class="destination-frequency">${freqText}</div>
                        </div>
                        <div class="time-axis">
                            <div class="axis-labels">
                                <span>0åˆ†</span>
                                <span>15åˆ†</span>
                                <span>30åˆ†</span>
                                <span>45åˆ†</span>
                            </div>
                `;
                
                // ç¾åœ¨ã®ç‰©ä»¶ã¨æœ€é€Ÿ3ã¤ã‚’è¡¨ç¤ºï¼ˆã‚½ãƒ¼ãƒˆæ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ï¼‰
                // ã¾ãšã€ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ç‰©ä»¶ã‚’å–å¾—ï¼ˆå…ƒã®areasã‹ã‚‰ï¼‰
                const selectedArea = areas[selectedAreaIndex];
                
                // å…¨ç‰©ä»¶ã®æ™‚é–“ã‚’å–å¾—ã—ã€ç¾åœ¨ã®ç‰©ä»¶ã‚’å„ªå…ˆè¡¨ç¤º
                const allAreaTimes = displayAreas.map(area => ({
                    area,
                    route: area.routes[destIndex],
                    time: area.routes[destIndex].total,
                    isSelected: (area.originalIndex !== undefined && area.originalIndex === selectedAreaIndex) || 
                               (area.originalIndex === undefined && area.name === selectedArea.name)
                }));
                
                // ç¾åœ¨ã®ç‰©ä»¶ã‚’æœ€åˆã«è¡¨ç¤º
                const currentAreaTime = allAreaTimes.find(item => item.isSelected) || allAreaTimes[0];
                html += generateTimeBar(currentAreaTime.area.name, currentAreaTime.route, currentAreaTime.time === minTime, true, maxTime);
                
                // ä»–ã®ç‰©ä»¶ã‚’è¡¨ç¤ºï¼ˆç¾åœ¨ã®ç‰©ä»¶ã‚’é™¤ã„ãŸæœ€åˆã®3ã¤ã€ã‚½ãƒ¼ãƒˆé †ï¼‰
                const otherAreas = allAreaTimes
                    .filter(item => !item.isSelected)
                    .slice(0, 3);
                
                otherAreas.forEach(item => {
                    const route = item.area.routes[destIndex];
                    html += generateTimeBar(item.area.name, route, route.total === minTime, false, maxTime);
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            compareContent.innerHTML = html;
        }
        
        function generateTimeBar(label, route, isBest, isCurrent, maxTime) {
            const barWidth = (route.total / maxTime) * 100;
            let segments = '';
            
            // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’æ§‹ç¯‰ï¼ˆæ•´åˆ—æ”¹å–„ï¼‰
            if (!route.lines || route.lines.length === 0) {
                // å¾’æ­©ã®ã¿
                segments = `<div class="time-segment segment-walk" style="width: 100%;">${route.walk > 5 ? route.walk + 'åˆ†' : ''}</div>`;
            } else {
                const totalTime = route.total;
                let segmentHTML = '';
                
                // å¾’æ­©ï¼ˆé§…ã¾ã§ï¼‰
                if (route.walk > 0) {
                    const walkWidth = (route.walk / totalTime) * 100;
                    segmentHTML += `<div class="time-segment segment-walk" style="width: ${walkWidth}%;">${route.walk > 3 ? route.walk : ''}</div>`;
                }
                
                // é›»è»Šã¨ä¹—æ›
                route.lines.forEach((line, i) => {
                    if (i > 0 && route.transfer && route.transfer > 0) {
                        const transferWidth = (route.transfer / totalTime) * 100;
                        segmentHTML += `<div class="time-segment segment-transfer" style="width: ${transferWidth}%;"></div>`;
                    }
                    const trainWidth = (line.time / totalTime) * 100;
                    segmentHTML += `<div class="time-segment segment-train" style="width: ${trainWidth}%;">${line.time > 5 ? line.time : ''}</div>`;
                });
                
                // å¾’æ­©ï¼ˆé§…ã‹ã‚‰ï¼‰
                if (route.walk2 > 0) {
                    const walkWidth = (route.walk2 / totalTime) * 100;
                    segmentHTML += `<div class="time-segment segment-walk" style="width: ${walkWidth}%;">${route.walk2 > 3 ? route.walk2 : ''}</div>`;
                }
                
                segments = segmentHTML;
            }
            
            return `
                <div class="property-comparison">
                    <div class="property-label ${isCurrent ? 'current' : ''}">${label}</div>
                    <div class="time-bar-container">
                        <span class="time-total">${route.total}åˆ†</span>
                        <div class="time-bar" style="width: ${barWidth}%;">
                            ${segments}
                        </div>
                        ${isBest ? '<span class="best-marker">âœ¨</span>' : ''}
                    </div>
                </div>
            `;
        }
        
        function drawMiniMap(canvasId, area) {
            // ã“ã®é–¢æ•°ã¯ä¸è¦ã«ãªã£ãŸã®ã§å‰Šé™¤
        }
        
        function updateRanking() {
            updateRankingView();
        }
        
        function updateRankingView() {
            const rankingList = document.getElementById('rankingList');
            if (!rankingList) {
                console.error('âŒ rankingList element not found!');
                return;
            }
            console.log('ğŸ“‹ Found rankingList element');
            
            // ç‰©ä»¶æƒ…å ±ã‚«ãƒ¼ãƒ‰ã¯ updateAreaInfo ã§æ›´æ–°ã•ã‚Œã‚‹
            updateAreaInfo();
            
            // ã‚½ãƒ¼ãƒˆæ¸ˆã¿ãƒªã‚¹ãƒˆã‚’ä½¿ç”¨ï¼ˆãƒ«ãƒ•ã‚©ãƒ³ãƒ—ãƒ­ã‚°ãƒ¬ã¯å¸¸ã«æœ€åˆï¼‰
            const displayAreas = sortedAreas.length > 0 ? sortedAreas : areas;
            console.log('ğŸ† updateRankingView: sortOrder=', currentSortOrder);
            console.log('ğŸ† Using:', sortedAreas.length > 0 ? 'sortedAreas' : 'areas', `(${displayAreas.length} items)`);
            console.log('ğŸ† Display order:', displayAreas.map((a, i) => `${i+1}.${a.name}`).slice(0, 3).join(', '), '...');
            console.log('ğŸ” Creating rankedAreas from', displayAreas.length, 'sorted items');
            const rankedAreas = displayAreas.map((area, sortedIndex) => {
                const { totalTime, totalWalkTime } = calculateMonthlyTimes(area);
                
                // é›»è»Šæ™‚é–“ã¨ä¹—æ›æ™‚é–“ã‚’è¨ˆç®—
                let totalTrainTime = 0;
                let totalTransferTime = 0;
                area.routes.forEach((route) => {
                    const dest = destinations[route.dest];
                    const frequency = dest.frequency || 1;
                    
                    // é›»è»Šæ™‚é–“
                    if (route.lines) {
                        route.lines.forEach(line => {
                            totalTrainTime += line.time * frequency * 2; // å¾€å¾©
                        });
                    }
                    
                    // ä¹—æ›æ™‚é–“
                    if (route.transfer) {
                        totalTransferTime += route.transfer * frequency * 2; // å¾€å¾©
                    }
                });
                
                // originalIndexãŒå­˜åœ¨ã™ã‚Œã°ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°å…ƒã®é…åˆ—ã‹ã‚‰ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ç‰¹å®š
                const originalIndex = area.originalIndex !== undefined ? 
                    area.originalIndex : 
                    areas.findIndex(originalArea => originalArea.name === area.name);
                
                return { area, index: originalIndex, totalTime, totalWalkTime, totalTrainTime, totalTransferTime };
            });
            
            let html = '';
            
            // å®¶è³ƒã‚½ãƒ¼ãƒˆã®å ´åˆ
            if (currentSortOrder === 'rent_asc') {
                // å®¶è³ƒã‚’æ•°å€¤ã«å¤‰æ›ã—ã¦æœ€å¤§å€¤ã‚’å–å¾—
                const rents = rankedAreas.map(item => parseRent(item.area.rent));
                const maxRentRaw = Math.max(...rents);
                const minRent = Math.min(...rents);
                // æœ€å¤§å€¤ã‚’åˆ‡ã‚Šä¸Šã’ï¼ˆ10ä¸‡å††å˜ä½ï¼‰
                const maxRent = Math.ceil(maxRentRaw / 100000) * 100000;
                
                rankedAreas.forEach((item, rank) => {
                    const rentValue = parseRent(item.area.rent);
                    // æœ€å°å€¤ã‚’20%ã€æœ€å¤§å€¤ã‚’100%ã«ãªã‚‹ã‚ˆã†ã«ã‚¹ã‚±ãƒ¼ãƒ«
                    const rentBarWidth = minRent === maxRent ? 100 : 
                        ((rentValue - minRent) / (maxRent - minRent)) * 80 + 20;
                    const hours = Math.floor(item.totalTime / 60);
                    const mins = Math.round(item.totalTime % 60);
                    
                    // ãƒ¡ãƒ€ãƒ«ã¾ãŸã¯é †ä½ç•ªå·
                    const medal = rank === 0 ? 'ğŸ¥‡' : rank === 1 ? 'ğŸ¥ˆ' : rank === 2 ? 'ğŸ¥‰' : '';
                    const currentClass = item.index === selectedAreaIndex ? 'current' : '';
                    
                    html += `
                        <div class="ranking-item ${currentClass}" onclick="selectFromRanking(${item.index})">
                            <div class="ranking-item-header">
                                ${medal ? `<span class="ranking-medal">${medal}</span>` : `<span class="ranking-number">${rank + 1}</span>`}
                                <span class="ranking-name">${item.area.name}</span>
                                <span class="ranking-time-total" style="color: #ffc107;">${item.area.rent}</span>
                            </div>
                            <div class="ranking-time-bar">
                                <div class="ranking-time-bar-fill" style="width: ${rentBarWidth}%; background: linear-gradient(90deg, #ffc107, #ffb300);">
                                    <span style="padding-left: 10px; font-size: 12px;">å®¶è³ƒ: ${item.area.rent}</span>
                                </div>
                            </div>
                            <div class="ranking-details">
                                <div class="ranking-detail-item">
                                    <span>æœˆé–“ç§»å‹•</span>
                                    <strong>${hours}h ${mins}m</strong>
                                </div>
                                <div class="ranking-detail-item">
                                    <span style="color: var(--color-walk);">å¾’æ­©æ™‚é–“</span>
                                    <strong>${Math.floor(item.totalWalkTime / 60)}h ${Math.round(item.totalWalkTime % 60)}m</strong>
                                </div>
                                <div class="ranking-detail-item">
                                    <span>é§…ã‹ã‚‰</span>
                                    <strong>${item.area.stationWalk || 'N/A'}åˆ†</strong>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                // æ™‚é–“ã‚½ãƒ¼ãƒˆã®å ´åˆï¼ˆæ—¢å­˜ã®å‡¦ç†ï¼‰
                // æœ€å¤§æ™‚é–“ã‚’å–å¾—ã—ã¦åˆ‡ã‚Šä¸Šã’ï¼ˆ60åˆ†å˜ä½ï¼‰
                const maxTimeRaw = Math.max(...rankedAreas.map(item => item.totalTime));
                const maxTime = Math.ceil(maxTimeRaw / 60) * 60;
                
                rankedAreas.forEach((item, rank) => {
                    const hours = Math.floor(item.totalTime / 60);
                    const mins = Math.round(item.totalTime % 60);
                    const walkPercent = Math.round((item.totalWalkTime / item.totalTime) * 100);
                    const trainPercent = Math.round((item.totalTrainTime / item.totalTime) * 100);
                    const transferPercent = Math.round((item.totalTransferTime / item.totalTime) * 100);
                    const barWidth = (item.totalTime / maxTime) * 100;
                    const walkBarWidth = (item.totalWalkTime / item.totalTime) * 100;
                    const trainBarWidth = (item.totalTrainTime / item.totalTime) * 100;
                    const transferBarWidth = (item.totalTransferTime / item.totalTime) * 100;
                    
                    // ãƒ¡ãƒ€ãƒ«ã¾ãŸã¯é †ä½ç•ªå·
                    const medal = rank === 0 ? 'ğŸ¥‡' : rank === 1 ? 'ğŸ¥ˆ' : rank === 2 ? 'ğŸ¥‰' : '';
                    const currentClass = item.index === selectedAreaIndex ? 'current' : '';
                    
                    html += `
                    <div class="ranking-item ${currentClass}" onclick="selectFromRanking(${item.index})">
                        <div class="ranking-item-header">
                            ${medal ? `<span class="ranking-medal">${medal}</span>` : `<span class="ranking-number">${rank + 1}</span>`}
                            <span class="ranking-name">${item.area.name}</span>
                            <span class="ranking-time-total">${hours}h ${mins}m</span>
                        </div>
                        <div class="ranking-time-bar">
                            <div class="ranking-time-bar-fill" style="width: ${barWidth}%">
                                <div class="ranking-walk-bar" style="width: ${walkBarWidth}%; background: var(--color-walk-gradient);">
                                    ${walkPercent > 10 ? `å¾’æ­© ${walkPercent}%` : ''}
                                </div>
                                ${item.totalTrainTime > 0 ? `
                                    <div class="ranking-train-bar" style="position: absolute; left: ${walkBarWidth}%; width: ${trainBarWidth}%; height: 100%; background: var(--color-train-gradient); opacity: 0.7; display: flex; align-items: center; padding-left: 6px;">
                                        ${trainPercent > 10 ? `<span style="font-size: 9px; color: white; font-weight: 600;">é›»è»Š ${trainPercent}%</span>` : ''}
                                    </div>
                                ` : ''}
                                ${item.totalTransferTime > 0 ? `
                                    <div class="ranking-transfer-bar" style="position: absolute; left: ${walkBarWidth + trainBarWidth}%; width: ${transferBarWidth}%; height: 100%; background: var(--color-transfer-gradient); opacity: 0.6; display: flex; align-items: center; padding-left: 4px;">
                                        ${transferPercent > 5 ? `<span style="font-size: 8px; color: white;">ä¹—æ›</span>` : ''}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="ranking-details">
                            <div class="ranking-detail-item">
                                <span style="color: var(--color-walk);">å¾’æ­©</span>
                                <strong>${Math.floor(item.totalWalkTime / 60)}h ${Math.round(item.totalWalkTime % 60)}m</strong>
                            </div>
                            <div class="ranking-detail-item">
                                <span style="color: var(--color-train);">é›»è»Š</span>
                                <strong>${Math.floor(item.totalTrainTime / 60)}h ${Math.round(item.totalTrainTime % 60)}m</strong>
                            </div>
                            ${item.totalTransferTime > 0 ? `
                                <div class="ranking-detail-item">
                                    <span style="color: var(--color-transfer);">ä¹—æ›</span>
                                    <strong>${Math.floor(item.totalTransferTime / 60)}h ${Math.round(item.totalTransferTime % 60)}m</strong>
                                </div>
                            ` : ''}
                            <div class="ranking-detail-item">
                                <span>|</span>
                                <strong>${item.area.rent}</strong>
                            </div>
                        </div>
                    </div>
                `;
                });
            }
            
            console.log('ğŸ¯ Updating ranking list DOM with', rankedAreas.length, 'items');
            rankingList.innerHTML = html;
            console.log('âœ… Ranking view updated successfully');
        }
        
        function selectFromRanking(originalIndex) {
            selectedAreaIndex = originalIndex;
            
            // ã‚½ãƒ¼ãƒˆæ¸ˆã¿ãƒªã‚¹ãƒˆã§ã®ä½ç½®ã‚’è¦‹ã¤ã‘ã‚‹
            const displayAreas = sortedAreas.length > 0 ? sortedAreas : areas;
            const sortedIndex = displayAreas.findIndex(area => area.originalIndex === originalIndex);
            if (sortedIndex !== -1) {
                document.getElementById('areaSelect').value = sortedIndex;
            }
            
            setViewMode('single');
            updateAreaInfo();
            animate();
        }
        
        function zoom(factor) {
            zoomScale *= factor;
            zoomScale = Math.max(0.5, Math.min(5, zoomScale));
            const zoomText = Math.round(zoomScale * 100) + '%';
            const zoomLevel = document.getElementById('zoomLevel');
            const zoomLevelInfo = document.getElementById('zoomLevelInfo');
            if (zoomLevel) zoomLevel.textContent = zoomText;
            if (zoomLevelInfo) zoomLevelInfo.textContent = zoomText;
            animate();
        }
        
        function resetView() {
            zoomScale = 1.0;  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®1.0ï¼ˆ100%ï¼‰ã«æˆ»ã™
            offsetX = 0;
            offsetY = 0;
            const zoomText = Math.round(zoomScale * 100) + '%';
            const zoomLevel = document.getElementById('zoomLevel');
            const zoomLevelInfo = document.getElementById('zoomLevelInfo');
            if (zoomLevel) zoomLevel.textContent = zoomText;
            if (zoomLevelInfo) zoomLevelInfo.textContent = zoomText;
            animate();
        }
        
        function selectPropertyMobile(sortedIndex) {
            const displayAreas = sortedAreas.length > 0 ? sortedAreas : areas;
            const selectedArea = displayAreas[sortedIndex];
            selectedAreaIndex = selectedArea.originalIndex || sortedIndex;
            
            document.querySelectorAll('.property-chip').forEach((chip, i) => {
                chip.classList.toggle('active', i === sortedIndex);
            });
            updateAreaInfo();
            animate();
        }
        
        function toggleBottomSheet() {
            bottomSheetExpanded = !bottomSheetExpanded;
            document.getElementById('bottomSheet').classList.toggle('expanded', bottomSheetExpanded);
        }
        
        // ========================================
        // ãƒã‚¦ã‚¹ãƒ»ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆ
        // ========================================
        canvas.addEventListener('mousedown', (e) => {
            isDragging = true;
            dragStartX = e.clientX;
            dragStartY = e.clientY;
            lastOffsetX = offsetX;
            lastOffsetY = offsetY;
            canvas.classList.add('grabbing');
        });
        
        canvas.addEventListener('mousemove', (e) => {
            if (isDragging) {
                offsetX = lastOffsetX + (e.clientX - dragStartX);
                offsetY = lastOffsetY + (e.clientY - dragStartY);
                animate();
            }
            
            // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—è¿½å¾“
            const info = document.getElementById('timeInfo');
            if (info.style.display === 'block') {
                info.style.left = e.pageX + 15 + 'px';
                info.style.top = e.pageY + 15 + 'px';
            }
        });
        
        canvas.addEventListener('mouseup', () => {
            isDragging = false;
            canvas.classList.remove('grabbing');
        });
        
        canvas.addEventListener('mouseleave', () => {
            isDragging = false;
            canvas.classList.remove('grabbing');
        });
        
        // ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã§ã‚ºãƒ¼ãƒ 
        canvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            const zoomFactor = e.deltaY > 0 ? 0.9 : 1.1;
            zoom(zoomFactor);
        });
        
        // ========================================
        // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆ
        // ========================================
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚„ã‚ºãƒ¼ãƒ ã‚’é˜²æ­¢
            if (e.touches.length === 1) {
                // 1æœ¬æŒ‡ã§ã®ãƒ‘ãƒ³
                isDragging = true;
                lastTouchX = e.touches[0].clientX;
                lastTouchY = e.touches[0].clientY;
                lastOffsetX = offsetX;
                lastOffsetY = offsetY;
                canvas.classList.add('grabbing');
            } else if (e.touches.length === 2) {
                // 2æœ¬æŒ‡ã§ã®ãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ 
                isPinching = true;
                lastZoomScale = zoomScale;
                initialPinchDistance = getPinchDistance(e.touches);
                pinchStartX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
                pinchStartY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
                lastOffsetX = offsetX;
                lastOffsetY = offsetY;
            }
        });
        
        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚„ã‚ºãƒ¼ãƒ ã‚’é˜²æ­¢
            if (isPinching && e.touches.length === 2) {
                // ãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ ä¸­
                const currentPinchDistance = getPinchDistance(e.touches);
                if (initialPinchDistance === 0) return; // è·é›¢ãŒ0ã®å ´åˆã¯å‡¦ç†ã—ãªã„

                const scaleFactor = currentPinchDistance / initialPinchDistance;
                let newZoomScale = lastZoomScale * scaleFactor;
                newZoomScale = Math.max(0.5, Math.min(5, newZoomScale)); // ã‚ºãƒ¼ãƒ ç¯„å›²ã‚’åˆ¶é™

                // ã‚ºãƒ¼ãƒ ã®ä¸­å¿ƒã‚’ç¶­æŒã™ã‚‹ãŸã‚ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆèª¿æ•´
                // ç”»é¢ä¸­å¿ƒã‚’åŸºæº–ã¨ã—ãŸãƒ”ãƒ³ãƒä¸­å¿ƒã®ç›¸å¯¾åº§æ¨™
                const relativePinchX = pinchStartX - (canvas.width / 2 + lastOffsetX);
                const relativePinchY = pinchStartY - (canvas.height / 2 + lastOffsetY);

                // æ–°ã—ã„ã‚ºãƒ¼ãƒ ã‚¹ã‚±ãƒ¼ãƒ«ã§ã®ç›¸å¯¾åº§æ¨™
                const newRelativePinchX = relativePinchX * (newZoomScale / lastZoomScale);
                const newRelativePinchY = relativePinchY * (newZoomScale / lastZoomScale);

                // æ–°ã—ã„ã‚ªãƒ•ã‚»ãƒƒãƒˆ
                offsetX = lastOffsetX + (relativePinchX - newRelativePinchX);
                offsetY = lastOffsetY + (relativePinchY - newRelativePinchY);

                zoomScale = newZoomScale;
                animate();
            } else if (isDragging && e.touches.length === 1) {
                // ãƒ‘ãƒ³ä¸­
                offsetX = lastOffsetX + (e.touches[0].clientX - lastTouchX);
                offsetY = lastOffsetY + (e.touches[0].clientY - lastTouchY);
                animate();
            }
        });
        
        canvas.addEventListener('touchend', () => {
            isDragging = false;
            isPinching = false;
            canvas.classList.remove('grabbing');
            initialPinchDistance = 0; // ãƒªã‚»ãƒƒãƒˆ
        });
        
        function getPinchDistance(touches) {
            const touch1 = touches[0];
            const touch2 = touches[1];
            return Math.sqrt(
                Math.pow(touch2.clientX - touch1.clientX, 2) +
                Math.pow(touch2.clientY - touch1.clientY, 2)
            );
        }
        
        // ========================================
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        // ========================================
        function animate() {
            // å€‹åˆ¥ãƒ“ãƒ¥ãƒ¼ã®æ™‚ã®ã¿ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’æç”»
            if (currentViewMode === 'single') {
                drawBackground();
                drawElements();
            }
        }
        
        // ========================================
        // ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼é–¢æ•°
        // ========================================
        function validateRouteTime(route) {
            // å„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®æ™‚é–“ã‚’åˆè¨ˆã—ã¦ã€total_timeã¨ä¸€è‡´ã™ã‚‹ã‹ç¢ºèª
            let calculatedTime = 0;
            
            if (route.details) {
                // å¾’æ­©ã®ã¿ã®å ´åˆ
                if (route.details.walk_only) {
                    calculatedTime = route.details.walk_time || 0;
                } else {
                    // é§…ã¾ã§
                    calculatedTime += route.details.walk_to_station || 0;
                    
                    // é›»è»Šã¨ä¹—æ›
                    if (route.details.trains) {
                        route.details.trains.forEach(train => {
                            calculatedTime += train.time || 0;
                            if (train.transfer_after) {
                                calculatedTime += train.transfer_after.time || 0;
                            }
                        });
                        
                        // æ—§å½¢å¼ã®ä¹—æ›æ™‚é–“
                        if (route.details.transfer_time) {
                            calculatedTime += route.details.transfer_time;
                        }
                    }
                    
                    // é§…ã‹ã‚‰
                    calculatedTime += route.details.walk_from_station || 0;
                }
            }
            
            if (calculatedTime !== route.total_time) {
                console.warn(`æ™‚é–“ã®ä¸ä¸€è‡´: ${route.destination}`, {
                    è¨ˆç®—å€¤: calculatedTime,
                    è¨˜è¼‰å€¤: route.total_time,
                    å·®åˆ†: route.total_time - calculatedTime
                });
            }
            
            return calculatedTime === route.total_time;
        }
        
        // ========================================
        // åˆæœŸåŒ–
        // ========================================
        // DOMContentLoadedã‚’å¾…ã¤
        async function initializeApp() {
            // ã¾ãšJSONãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
            await loadDataFromJSON();
            
            // ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã‚‰åˆæœŸåŒ–å‡¦ç†ã‚’ç¶™ç¶š
            if (areas.length > 0) {
                updateAreaInfo();
                const zoomText = Math.round(zoomScale * 100) + '%';
            const zoomLevel = document.getElementById('zoomLevel');
            const zoomLevelInfo = document.getElementById('zoomLevelInfo');
            if (zoomLevel) zoomLevel.textContent = zoomText;
            if (zoomLevelInfo) zoomLevelInfo.textContent = zoomText;
                
                // åˆæœŸè¡¨ç¤ºã‚’ç¢ºå®Ÿã«ä¸­å¤®ã«
                setTimeout(() => {
                    if (currentViewMode === 'single') {
                        animate();
                    }
                }, 100);
            }
        }
        
        // DOMãŒå®Œå…¨ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã‹ã‚‰åˆæœŸåŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
        
    </script>
</body>
</html>