<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Maps Integration Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 4px;
        }
        input {
            width: 300px;
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }
        .error {
            background: #ffe0e0;
            color: #d00;
        }
        .success {
            background: #e0ffe0;
        }
        .info {
            background: #e0e0ff;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Google Maps Integration Test</h1>
        
        <div class="info">
            <strong>ãƒ†ã‚¹ãƒˆç’°å¢ƒ:</strong> https://japandatascience.com/timeline-mapping/api/google_maps_integration.php<br>
            <strong>ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ‘ãƒ¼:</strong> google_maps_scraper.py (æ—§ ultimate)
        </div>

        <!-- æ¥ç¶šãƒ†ã‚¹ãƒˆ -->
        <div class="test-section">
            <h2>1. æ¥ç¶šãƒ†ã‚¹ãƒˆ</h2>
            <button onclick="testConnection()">æ¥ç¶šãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
            <div id="connectionResult" class="result" style="display:none;"></div>
        </div>

        <!-- å˜ä¸€ãƒ«ãƒ¼ãƒˆæ¤œç´¢ãƒ†ã‚¹ãƒˆ -->
        <div class="test-section">
            <h2>2. å˜ä¸€ãƒ«ãƒ¼ãƒˆæ¤œç´¢ãƒ†ã‚¹ãƒˆ</h2>
            <div>
                <input type="text" id="origin" placeholder="å‡ºç™ºåœ°" value="ãƒ«ãƒ•ã‚©ãƒ³ãƒ—ãƒ­ã‚°ãƒ¬ç¥ç”°ãƒ—ãƒ¬ãƒŸã‚¢">
                <input type="text" id="destination" placeholder="ç›®çš„åœ°" value="è‡³å–„é¤¨">
                <br>
                <button onclick="testSingleRoute()">ãƒ«ãƒ¼ãƒˆæ¤œç´¢</button>
                <button onclick="testWithArrivalTime()">å¹³æ—¥10æ™‚åˆ°ç€ã§æ¤œç´¢</button>
            </div>
            <div id="routeResult" class="result" style="display:none;"></div>
        </div>

        <!-- JSONå½¢å¼ç¢ºèª -->
        <div class="test-section">
            <h2>3. JSONå½¢å¼ç¢ºèª</h2>
            <button onclick="checkJsonFormat()">ç¾åœ¨ã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª</button>
            <div id="jsonResult" class="result" style="display:none;"></div>
        </div>

        <!-- ãƒãƒƒãƒãƒ†ã‚¹ãƒˆ -->
        <div class="test-section">
            <h2>4. ãƒãƒƒãƒãƒ†ã‚¹ãƒˆï¼ˆä¸»è¦ãƒ«ãƒ¼ãƒˆï¼‰</h2>
            <button onclick="testBatchRoutes()">ä¸»è¦9ãƒ«ãƒ¼ãƒˆã‚’ãƒ†ã‚¹ãƒˆ</button>
            <div id="batchResult" class="result" style="display:none;"></div>
        </div>
    </div>

    <script>
        async function testConnection() {
            const resultDiv = document.getElementById('connectionResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = 'æ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...';
            
            try {
                const response = await fetch('/timeline-mapping/api/google_maps_integration.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'testConnection' })
                });
                
                const data = await response.json();
                resultDiv.textContent = JSON.stringify(data, null, 2);
                resultDiv.className = data.success ? 'result success' : 'result error';
            } catch (error) {
                resultDiv.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + error.message;
                resultDiv.className = 'result error';
            }
        }

        async function testSingleRoute() {
            const origin = document.getElementById('origin').value;
            const destination = document.getElementById('destination').value;
            const resultDiv = document.getElementById('routeResult');
            
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = 'æ¤œç´¢ä¸­...';
            
            try {
                const response = await fetch('/timeline-mapping/api/google_maps_integration.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'getSingleRoute',
                        origin: origin,
                        destination: destination,
                        destinationId: 'test-destination',
                        destinationName: destination
                    })
                });
                
                const data = await response.json();
                resultDiv.textContent = JSON.stringify(data, null, 2);
                resultDiv.className = data.success ? 'result success' : 'result error';
                
                if (data.success && data.route) {
                    // é‡è¦ãªæƒ…å ±ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                    const route = data.route;
                    const summary = `
=== ãƒ«ãƒ¼ãƒˆæ¦‚è¦ ===
ç·æ‰€è¦æ™‚é–“: ${route.total_time}åˆ†
å¾’æ­©æ™‚é–“åˆè¨ˆ: ${route.total_walk_time || 'ä¸æ˜'}åˆ†

=== è©³ç´° ===
é§…ã¾ã§å¾’æ­©: ${route.details.walk_to_station}åˆ†
ä½¿ç”¨é§…: ${route.details.station_used}
é›»è»Š: ${route.details.trains.map(t => `${t.line} (${t.time}åˆ†)`).join(', ')}
é§…ã‹ã‚‰å¾’æ­©: ${route.details.walk_from_station}åˆ†
å¾…ã¡æ™‚é–“: ${route.details.wait_time_minutes}åˆ†

=== å®Œå…¨ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ ===
${JSON.stringify(data, null, 2)}`;
                    resultDiv.textContent = summary;
                }
            } catch (error) {
                resultDiv.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + error.message;
                resultDiv.className = 'result error';
            }
        }

        async function testWithArrivalTime() {
            const origin = document.getElementById('origin').value;
            const destination = document.getElementById('destination').value;
            const resultDiv = document.getElementById('routeResult');
            
            // æ¬¡ã®å¹³æ—¥ã®10æ™‚ã‚’è¨ˆç®—
            const arrivalTime = getNextWeekday10AM();
            
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = `å¹³æ—¥10æ™‚åˆ°ç€ï¼ˆ${arrivalTime.toLocaleString()}ï¼‰ã§æ¤œç´¢ä¸­...`;
            
            try {
                const response = await fetch('/timeline-mapping/api/google_maps_integration.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'getSingleRoute',
                        origin: origin,
                        destination: destination,
                        destinationId: 'test-destination',
                        destinationName: destination,
                        arrivalTime: arrivalTime.toISOString()
                    })
                });
                
                const data = await response.json();
                resultDiv.textContent = JSON.stringify(data, null, 2);
                resultDiv.className = data.success ? 'result success' : 'result error';
            } catch (error) {
                resultDiv.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + error.message;
                resultDiv.className = 'result error';
            }
        }

        function getNextWeekday10AM() {
            const now = new Date();
            let targetDate = new Date(now);
            
            // ä»Šæ—¥ãŒå¹³æ—¥ã§10æ™‚å‰ãªã‚‰ä»Šæ—¥ã€ãã‚Œä»¥å¤–ã¯æ¬¡ã®å¹³æ—¥
            if (now.getDay() >= 1 && now.getDay() <= 5 && now.getHours() < 10) {
                targetDate.setHours(10, 0, 0, 0);
            } else {
                // æ¬¡ã®å¹³æ—¥ã‚’æ¢ã™
                targetDate.setDate(targetDate.getDate() + 1);
                while (targetDate.getDay() === 0 || targetDate.getDay() === 6) {
                    targetDate.setDate(targetDate.getDate() + 1);
                }
                targetDate.setHours(10, 0, 0, 0);
            }
            
            return targetDate;
        }

        async function checkJsonFormat() {
            const resultDiv = document.getElementById('jsonResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = 'JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...';
            
            try {
                const [destResponse, propResponse] = await Promise.all([
                    fetch('/timeline-mapping/data/destinations.json'),
                    fetch('/timeline-mapping/data/properties.json')
                ]);
                
                const destinations = await destResponse.json();
                const properties = await propResponse.json();
                
                resultDiv.textContent = `=== destinations.json ===
${JSON.stringify(destinations.destinations[0], null, 2)}

=== properties.json (æœ€åˆã®ç‰©ä»¶ã€æœ€åˆã®ãƒ«ãƒ¼ãƒˆ) ===
${JSON.stringify(properties.properties[0]?.routes?.[0], null, 2)}

=== çµ±è¨ˆæƒ…å ± ===
ç›®çš„åœ°æ•°: ${destinations.destinations.length}
ç‰©ä»¶æ•°: ${properties.properties.length}
`;
            } catch (error) {
                resultDiv.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + error.message;
                resultDiv.className = 'result error';
            }
        }

        async function testBatchRoutes() {
            const resultDiv = document.getElementById('batchResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            
            const testRoutes = [
                { from: 'ãƒ«ãƒ•ã‚©ãƒ³ãƒ—ãƒ­ã‚°ãƒ¬ç¥ç”°ãƒ—ãƒ¬ãƒŸã‚¢', to: 'è‡³å–„é¤¨' },
                { from: 'ãƒ«ãƒ•ã‚©ãƒ³ãƒ—ãƒ­ã‚°ãƒ¬ç¥ç”°ãƒ—ãƒ¬ãƒŸã‚¢', to: 'æ±äº¬ã‚¢ãƒ¡ãƒªã‚«ãƒ³ã‚¯ãƒ©ãƒ–' },
                { from: 'ãƒ«ãƒ•ã‚©ãƒ³ãƒ—ãƒ­ã‚°ãƒ¬ç¥ç”°ãƒ—ãƒ¬ãƒŸã‚¢', to: 'axleå¾¡èŒ¶ãƒæ°´' },
                { from: 'ãƒ«ãƒ•ã‚©ãƒ³ãƒ—ãƒ­ã‚°ãƒ¬ç¥ç”°ãƒ—ãƒ¬ãƒŸã‚¢', to: 'Yawara' },
                { from: 'ãƒ«ãƒ•ã‚©ãƒ³ãƒ—ãƒ­ã‚°ãƒ¬ç¥ç”°ãƒ—ãƒ¬ãƒŸã‚¢', to: 'æ—©ç¨²ç”°å¤§å­¦' },
                { from: 'ãƒ«ãƒ•ã‚©ãƒ³ãƒ—ãƒ­ã‚°ãƒ¬ç¥ç”°ãƒ—ãƒ¬ãƒŸã‚¢', to: 'ç¾½ç”°ç©ºæ¸¯' },
                { from: 'ãƒ«ãƒ•ã‚©ãƒ³ãƒ—ãƒ­ã‚°ãƒ¬ç¥ç”°ãƒ—ãƒ¬ãƒŸã‚¢', to: 'æ±äº¬é§…' },
                { from: 'ãƒ«ãƒ•ã‚©ãƒ³ãƒ—ãƒ­ã‚°ãƒ¬ç¥ç”°ãƒ—ãƒ¬ãƒŸã‚¢', to: 'ä¸Šé‡é§…' },
                { from: 'ãƒ«ãƒ•ã‚©ãƒ³ãƒ—ãƒ­ã‚°ãƒ¬ç¥ç”°ãƒ—ãƒ¬ãƒŸã‚¢', to: 'ç¥ç”°é§…' }
            ];
            
            let results = [];
            
            for (let i = 0; i < testRoutes.length; i++) {
                const route = testRoutes[i];
                resultDiv.textContent = `ãƒ†ã‚¹ãƒˆä¸­... (${i + 1}/${testRoutes.length})\n${route.from} â†’ ${route.to}`;
                
                try {
                    const response = await fetch('/timeline-mapping/api/google_maps_integration.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'getSingleRoute',
                            origin: route.from,
                            destination: route.to,
                            destinationId: `test-${i}`,
                            destinationName: route.to
                        })
                    });
                    
                    const data = await response.json();
                    if (data.success && data.route) {
                        results.push({
                            route: `${route.from} â†’ ${route.to}`,
                            time: data.route.total_time,
                            line: data.route.details.trains?.[0]?.line || 'ä¸æ˜',
                            status: 'âœ…'
                        });
                    } else {
                        results.push({
                            route: `${route.from} â†’ ${route.to}`,
                            error: data.error,
                            status: 'âŒ'
                        });
                    }
                } catch (error) {
                    results.push({
                        route: `${route.from} â†’ ${route.to}`,
                        error: error.message,
                        status: 'âŒ'
                    });
                }
                
                // APIã‚µãƒ¼ãƒãƒ¼ã«è² è·ã‚’ã‹ã‘ãªã„ã‚ˆã†å¾…æ©Ÿ
                await new Promise(resolve => setTimeout(resolve, 2000));
            }
            
            // çµæœã‚’ãƒ†ãƒ¼ãƒ–ãƒ«å½¢å¼ã§è¡¨ç¤º
            const summary = results.map(r => 
                r.status === 'âœ…' 
                    ? `${r.status} ${r.route}: ${r.time}åˆ† (${r.line})`
                    : `${r.status} ${r.route}: ${r.error}`
            ).join('\n');
            
            const successCount = results.filter(r => r.status === 'âœ…').length;
            
            resultDiv.textContent = `=== ãƒ†ã‚¹ãƒˆçµæœ ===
æˆåŠŸ: ${successCount}/${testRoutes.length}

${summary}`;
            resultDiv.className = successCount === testRoutes.length ? 'result success' : 'result';
        }
    </script>
</body>
</html>