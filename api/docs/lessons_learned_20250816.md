# 今回の作業で判明した重要事項 - 2025/08/16

## 1. ID不一致問題の根本原因

### 問題
- 22物件×9目的地=198ルートが処理されたが、実際は5/9の目的地IDが一致していなかった
- destinations.json: `yawara_gym`, `kamiyacho_ee_office`
- properties.json: `yawara`, `kamiyacho_ee`

### 原因
**json-generator.htmlのgenerateId関数が日本語を削除してしまう設計**
```javascript
function generateId(name) {
    return name.toLowerCase()
        .replace(/[^\w\s]/gi, '')  // 日本語や記号を削除
        .replace(/\s+/g, '_')       
        .substring(0, 20);
}
```

### 影響
- "Yawara Gym" → "yawara_gym" → 実際の処理では "yawara"
- "神谷町(EE) Office" → "ee_office" → 実際の処理では "kamiyacho_ee"

### 解決策
destinations.jsonのIDを実際に使用されているIDに修正

## 2. 処理件数の誤解

### 誤解していた内容
- 207件の物件があると思っていた
- 実際は23物件×9目的地=207ルート

### 実際の状況
- 物件数: 23件（後に25件に増加）
- 目的地数: 9件
- 総ルート数: 225件（25×9）

## 3. メモリリーク対策の効果

### 実装した対策
1. 各ルート処理後のクリーンアップ
2. 30ルートごとのWebDriver再起動
3. ガベージコレクション実行

### 結果
- スワップ使用率: 99% → 24%に改善
- 安定した長時間処理が可能に

## 4. Place IDキャッシュの効果

### 効果
- 2回目以降の同一地点検索で5秒短縮
- 3物件の処理時間: 約5分で完了

## 5. ハードコード検証結果

### 本番環境
- **google_maps_integration.php**: ハードコードなし ✅
- **google_maps_api_server_v3.py**: ハードコードなし ✅
- 外部からorigin/destinationを受け取って処理

### テスト環境
- 多数のテストファイルでハードコードあり（問題なし）

## 6. データ構造の不一致

### 問題点
- generateId関数が生成するIDと実際の処理で使うIDが異なる
- 日本語を含む名前の場合、ID生成が正しく機能しない

### 推奨事項
1. ID生成ロジックの統一
2. 日本語対応のID生成関数の実装
3. または、事前定義されたIDの使用

## 7. 完了画面への遷移問題

### 問題
- 207件処理完了後、自動的に完了画面に遷移しなかった

### 原因
- 処理数と期待数の不一致によるもの

### 回避策
```javascript
currentStep = 4;
updateStepDisplay();
```

## 8. 重複物件の発見

### 発見内容
- パトリス神保町 1101
- La Belle 三越前 702
これらは既に処理済みだったが、再度処理リストに含まれていた

## まとめ

### 成功した点
1. メモリリーク問題の解決
2. 全225ルートの取得完了
3. ID不一致問題の特定と修正
4. Place IDキャッシュによる高速化

### 改善が必要な点
1. ID生成ロジックの統一
2. 処理状況の正確な把握
3. 重複チェック機能の実装
4. エラーハンドリングの強化

### 次回への申し送り
1. 新規目的地追加時はID形式に注意
2. 大量処理時は30件ごとの再起動が有効
3. destinations.jsonとproperties.jsonのID一致を常に確認
4. Place ID事前取得による時間短縮を活用