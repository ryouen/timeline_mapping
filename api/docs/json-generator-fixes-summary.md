# json-generator.html 修正内容まとめ

## 実装した修正

### 1. 現住所問題の根本的解決

#### 問題点
- 現住所が既に存在するのに重複登録を求められる
- 現住所（最初の物件）に削除ボタンがない
- フォームとデータの同期が取れていない

#### 修正内容

1. **validateCurrentStep関数の改善**
   - 物件が0件の場合のみ新規作成
   - 既存物件がある場合は更新のみ
   - 重複チェックを廃止

2. **updatePropertiesList関数の改善**
   - すべての物件に削除ボタンを表示（最後の1件は「削除不可」表示）
   - 現住所切り替えボタンを追加
   - UIの改善（フロート配置、色分け）

3. **削除機能の安全性向上**
   - 最低1件の物件を保証
   - 現住所削除時の確認と自動切り替え
   - 削除後のフォーム同期

4. **データ同期の改善**
   - syncCurrentAddressToForm関数の追加
   - loadFromLocalStorageでフォームへ反映
   - Step 2進入時の自動同期

5. **現住所切り替え機能**
   - makeCurrentAddress関数の追加
   - 任意の物件を現住所に設定可能

### 2. 復元機能の修正

#### 問題点
- 復元ボタンをクリックしてもサーバーに保存されない
- index.htmlに反映されない

#### 修正内容

1. **restorePreviousSearch関数の改善**
   - asyncに変更
   - saveJSONFiles()を追加してサーバー保存
   - 処理中表示の追加
   - エラーハンドリングの強化
   - 復元結果の詳細表示

## 使用方法

### 現住所の管理

1. **新規登録時**
   - Step 2のフォームに入力
   - 「次へ」で自動登録

2. **既存物件がある場合**
   - フォームに現在の現住所が自動表示
   - 変更する場合は編集して「次へ」
   - 変更しない場合はそのまま「次へ」

3. **現住所の削除**
   - 削除ボタンをクリック（最後の1件は削除不可）
   - 確認ダイアログで承認
   - 次の物件が自動的に現住所になる

4. **現住所の切り替え**
   - 任意の物件の「現住所に設定」ボタンをクリック
   - 確認後、順序が入れ替わる
   - フォームも自動更新

### 検索結果の復元

1. **Step 3で自動検出**
   - LocalStorageにルート検索済みデータがある場合
   - 「以前のルート検索結果が見つかりました」と表示

2. **復元手順**
   - 「以前の検索結果を復元」ボタンをクリック
   - データがサーバーに保存される
   - Step 4（完了画面）へ自動遷移
   - JSONファイルのダウンロード可能

## 技術的詳細

### データフロー
```
LocalStorage
    ↓ (load)
properties配列
    ↓ (sync)
フォーム（現住所編集用）
    ↓ (update)
properties[0]更新
    ↓ (save)
LocalStorage & サーバー
```

### 重要な原則
- 現住所 = properties[0]（固定）
- 最低1件の物件を保証（index.html互換）
- フォームは現住所の編集専用インターフェース

## バックアップ
- `~/json-generator.html.backup_20250813_011735`