# Google Maps スクレイピング問題の詳細分析

最終更新: 2025-08-14 18:30

## 問題の概要

Google Mapsスクレイピングシステムが正しいルート情報を取得できていない。特に府中オフィスへのルートが「8分」という異常に短い時間になっている。

## 主要な問題点

### 1. 府中オフィスルートの異常
- **現在の結果**: 8分（神田→日本橋）
- **正しい結果**: 約48分（神田→府中、中央線快速で35分＋徒歩10分）
- **原因**: スクレイピングシステムが「府中」を正しく認識できず、近隣の駅（日本橋）として処理している

### 2. デバッグファイルの解析結果

`page_source_ルフォンプログレ神田-東京都府中市住吉町5-20250814_115519.html`を調査した結果：

1. **URLは正しく生成されている**
   - 出発地: ルフォンプログレ神田プレミア
   - 目的地: 東京都府中市住吉町5-22-5
   
2. **しかしGoogle Mapsは「ＮＥＣ中河原技術センター」として認識**
   - `<title>ルフォンプログレ神田プレミア から ＮＥＣ中河原技術センター - Google マップ</title>`
   - 府中市住吉町5-22-5は「ＮＥＣ中河原技術センター」として解釈されている
   
3. **結果として取得されるルート**
   - 神田駅から日本橋（近隣の駅）への経路が表示されている
   - これが「8分」という短時間の原因

### 3. スクレイピングロジックの問題

`google_maps_scraper.py`の分析：

1. **フォールバック処理の問題**
   ```python
   # 最小限の情報を保証（576-585行目）
   if not route_info['trains']:
       route_info['trains'] = [{
           'line': '銀座線',
           'time': 3,
           'from': '神田',
           'to': '日本橋'  # ハードコーディングされている！
       }]
   ```
   - ルート情報が取得できない場合、デフォルトで「神田→日本橋」を返している
   
2. **到着駅の推定ロジック**
   ```python
   # 到着駅を推定（日本橋がデフォルト）（479-480行目）
   to_station = '日本橋'
   ```
   - 到着駅が取得できない場合、常に「日本橋」として処理

3. **エラーハンドリングの不足**
   - 長距離ルートの場合の特別な処理がない
   - 住所が正しく認識されない場合の検証がない

## 根本原因

1. **Google Mapsの住所解釈**
   - 「東京都府中市住吉町5-22-5」が「ＮＥＣ中河原技術センター」として解釈される
   - この結果、期待する府中駅への経路ではなく、別の経路が返される

2. **スクレイピングシステムの設計**
   - エラー時のフォールバックが「神田→日本橋」にハードコーディング
   - 長距離ルートや複雑な経路に対する適切な処理がない

3. **データ検証の欠如**
   - 取得したルートの妥当性チェックがない（8分で府中に行けるはずがない）
   - 住所と実際の目的地の一致確認がない

## 解決策の提案

### 1. 即時対応
- フォールバックのハードコーディングを削除
- エラー時は明確にエラーを返すように修正
- 取得したルートの妥当性チェックを追加（距離と時間の相関）

### 2. 中期的対応
- 住所の正規化処理を強化
- Google Maps APIの使用を検討（より安定した結果が期待できる）
- 複数の検索パターンを試行（住所、施設名、座標など）

### 3. 長期的対応
- スクレイピングではなくAPIベースのアプローチに移行
- エラーログとモニタリングの強化
- ゴールデンファイル（正解データ）による継続的なテスト

## 次のステップ

1. `google_maps_scraper.py`の修正
   - フォールバック処理の改善
   - エラーハンドリングの強化
   
2. テストケースの追加
   - 府中オフィスルートのテスト
   - 長距離ルートのテスト
   
3. データ検証の実装
   - 時間と距離の妥当性チェック
   - 住所認識の確認