# 到着時刻設定変更の影響範囲分析とリスク評価

**作成日**: 2025年8月13日  
**目的**: 「平日午前9時出発」から「平日午前10時到着」への変更に伴う影響とリスクの評価

## 1. 変更の概要

### 要求仕様
- **現在**: 平日午前9時出発（実装されていない、デフォルト動作）
- **変更後**: 平日午前10時到着（明示的な実装が必要）

### 技術的変更点
1. URL形式の変更（安全性向上）
   - `data=!`記法 → `?travelmode=transit`形式
2. 到着時刻パラメータの追加
   - `arrival_time`パラメータの実装

## 2. 影響を受けるコンポーネント

### 2.1 フロントエンド（json-generator.html）
**変更箇所**:
- `startRouteSearch()`関数
- `searchSingleRoute()`関数
- 到着時刻の計算ロジックの追加

**影響度**: 中
- ユーザー向けの表示は既に「平日午前10時到着」となっている
- 実装と表示の不一致を解消

### 2.2 APIゲートウェイ（google_maps_integration.php）
**変更箇所**:
- `getSingleRoute()`関数
- `callExistingAPIServer()`関数
- arrival_timeパラメータの受け渡し

**影響度**: 低
- パラメータを追加で受け取るだけ
- 既存のロジックへの影響は最小限

### 2.3 APIサーバー（google_maps_api_server.py）
**変更箇所**:
- 既にarrival_timeパラメータをサポート
- 変更不要の可能性

**影響度**: なし

### 2.4 スクレイピング実装（google_maps_transit_docker.py）
**変更箇所**:
- `extract_route_details()`関数のURL生成部分
- data=!記法から?travelmode形式への変更
- arrival_timeパラメータの処理

**影響度**: 高
- コア機能の変更
- すべてのルート検索に影響

## 3. リスク評価

### 3.1 高リスク項目

#### Google Maps URLパラメータの非公式性
- **リスク**: Googleが予告なくパラメータを変更する可能性
- **対策**: 
  - 両方のURL形式をサポート（フォールバック）
  - エラー検知と自動切り替え機能

#### Seleniumスクレイピングの不安定性
- **リスク**: ページ構造の変更により動作しなくなる
- **対策**:
  - 複数のセレクタを試行
  - エラーログの詳細記録
  - 定期的な動作確認

### 3.2 中リスク項目

#### 184物件×8目的地の大量処理
- **リスク**: 一部のルートでエラーが発生する可能性
- **対策**:
  - エラー時の再試行機能
  - 部分的な成功を許容
  - 進捗の保存機能

#### 時刻計算の複雑性
- **リスク**: タイムゾーン、祝日、夏時間などの考慮漏れ
- **対策**:
  - 日本時間（JST）に固定
  - 祝日判定は行わない（平日のみ）

### 3.3 低リスク項目

#### 既存データとの互換性
- **リスク**: 以前に生成されたJSONファイルとの不整合
- **対策**:
  - 新しいフィールドは追加のみ（既存フィールドは変更しない）
  - バージョン情報の付与

## 4. テスト戦略

### 4.1 単体テスト
1. URL生成ロジックのテスト
2. 到着時刻計算のテスト
3. 住所調整機能のテスト

### 4.2 統合テスト
1. 実際のGoogle Mapsでの動作確認
2. APIサーバーとの通信テスト
3. エンドツーエンドのルート検索

### 4.3 回帰テスト
1. テラス月島801の3ルート
2. ランダムに選んだ10物件
3. すべての目的地との組み合わせ

## 5. 実装の優先順位

### Phase 1: URL形式の変更（即座に実施）
- ハイフンを含む番地の問題を解決
- 安定性の向上

### Phase 2: 到着時刻の実装（慎重に実施）
- 時刻計算ロジックの実装
- パラメータの受け渡し
- 動作確認

### Phase 3: エラーハンドリングの強化
- 再試行機能
- 詳細なログ記録
- ユーザーへのフィードバック

## 6. ロールバック計画

万が一問題が発生した場合：
1. バックアップから即座に復元
2. APIサーバーの再起動
3. 以前のURL形式に戻す

バックアップ場所:
- `/home/ubuntu/backup/timeline-mapping/2025-08-13-before-arrival-time-change/`

## 7. 成功の基準

1. テラス月島801のエラーが解消される
2. 平日午前10時到着でルート検索される
3. 既存の184物件すべてで動作する
4. エラー率が1%未満になる

## 8. 推奨事項

1. **段階的な実装**を強く推奨
2. **各段階でのテスト**を必須とする
3. **ユーザーへの事前通知**を検討
4. **監視体制**の確立（初回実行時）