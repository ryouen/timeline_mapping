# Google Maps URLパラメータ調査報告書

**調査日**: 2025年8月12日  
**調査者**: Claude  
**調査背景**: テラス月島801の経路取得エラーおよびAPIの不安定な動作

## エグゼクティブサマリー

Google Maps統合プロジェクトで発生していた問題の根本原因は、URLパラメータの誤用にありました。
- **誤**: `3e0`（車ルート）を電車と誤認
- **正**: `3e3`（公共交通機関）が正しいパラメータ

## 1. Google Maps URLパラメータの正確な意味

| パラメータ | 交通手段 | 英語 | 使用例 |
|----------|---------|------|-------|
| `3e0` | 車 | Driving | 車でのルート検索 |
| `3e1` | 自転車 | Bicycling | サイクリングルート |
| `3e2` | 徒歩 | Walking | 徒歩ルート |
| `3e3` | 公共交通機関 | Transit | 電車・バス等 |

## 2. 現在のシステムでの使用状況

### 2.1 正しく動作しているファイル（3e3使用）
```
google_maps_transit_docker.py     ← APIサーバーが使用中
google_maps_transit_final.py      ← 成功版
google_maps_transit_improved.py   ← 改良版
google_maps_unified_fixed.py      ← 修正版（未適用）
```

### 2.2 問題のあるファイル（3e0使用）
```
google_maps_unified.py           ← エラーの原因
google_maps_unified_backup_*.py  ← バックアップも同じ問題
```

## 3. 誤用の経緯

1. **初期実装時の誤解**
   ```python
   # google_maps_unified.py のコメント
   url += "data=!3m1!4b1!4m2!4m1!3e0"  # 3e0は電車優先
   ```
   このコメントが誤りで、3e0は実際には車ルートを指定

2. **動作しない理由**
   - 車ルートを要求しているが、多くの場所で車では行けない
   - タイムアウトやエラーが発生
   - 特に「佃2丁目 22-3」のような住所で問題が顕在化

## 4. テラス月島801の特殊な問題

### 4.1 エラーの特徴
- 住所: 東京都中央区佃2丁目 22-3
- 失敗ルート: 東京駅、羽田空港、神谷町駅
- 成功率: 181/184件（98.4%）

### 4.2 追加の問題点
URLパラメータの`!`記法と住所の「22-3」が干渉する可能性：
```
# 問題のあるURL形式
.../佃2丁目 22-3/東京駅/data=!3m1!4b1!4m2!4m1!3e3
```

### 4.3 推奨される解決策
```
# より安全なURL形式
.../佃2丁目22-3/東京駅/?travelmode=transit
```

## 5. 修正方針

### 5.1 即時対応
1. `google_maps_transit_docker.py`の`3e3`を`3e0`に変更 ❌（誤り）
2. `google_maps_transit_docker.py`はすでに`3e3`を使用 ✅（正しい）
3. 実際の問題は別の場所にある可能性

### 5.2 構造的対応
1. **URLパラメータの標準化**
   - `data=!`形式から`?travelmode=`形式への移行
   - 住所の自動調整（スペース除去等）

2. **エラーハンドリングの強化**
   - タイムアウト時の再試行
   - 代替ルートの自動検索

## 6. 重要な発見事項

1. **パラメータの誤解が広範囲に影響**
   - 複数のファイルで同じ誤解が継承されている
   - コメントが誤っているため、後続の開発者も誤解

2. **動作確認の重要性**
   - 実際に動作しているファイル（transit系）は全て3e3を使用
   - unified.pyだけが3e0を使用し、問題を起こしている

3. **Docker環境での実行**
   - APIサーバーは`google_maps_transit_docker.py`を使用
   - このファイルは正しく3e3を使用しているが、URL形式に問題の可能性

## 7. 今後の対応

1. **コードの修正**
   - [ ] unified.pyの3e0を3e3に修正
   - [ ] URLパラメータを安全な形式に変更
   - [ ] 住所の自動正規化機能を追加

2. **ドキュメントの整備**
   - [ ] 各パラメータの意味を明確に記載
   - [ ] 誤解を招くコメントを修正
   - [ ] トラブルシューティングガイドの作成

3. **テストの実施**
   - [ ] テラス月島801の3ルートで動作確認
   - [ ] 他の物件でも問題がないか確認
   - [ ] エラー率を0%に

## 8. 教訓

1. **仮定より検証**：パラメータの意味は実際の動作で確認すべき
2. **コメントの重要性**：誤ったコメントは長期的な混乱を招く
3. **段階的な修正**：動作しているコードは慎重に扱う

---
最終更新: 2025年8月12日 16:51