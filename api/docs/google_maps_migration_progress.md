# Google Maps移行プロジェクト進捗状況

最終更新: 2025-08-14 14:50

## プロジェクト概要

Yahoo乗換案内からGoogle Mapsへの移行プロジェクト。主な理由は徒歩時間の信頼性向上。

## 🎉 2025-08-13 重要アップデート：本番稼働開始

### 解決した2つの重要課題
1. **ハイフン付き住所問題** ✅
   - 問題: テラス月島801（佃2丁目 22-3）など、ハイフン付き住所で検索失敗
   - 原因: URL内の`data=!`パラメータがハイフンと干渉
   - 解決: `?travelmode=transit`形式に変更
   - 結果: 全184物件で正常動作確認

2. **到着時刻機能の実装** ✅
   - 変更前: 平日午前9時出発で検索
   - 変更後: 平日午前10時到着で検索
   - 実装: json-generator.html、google_maps_integration.php更新

## 🚨 2025-08-14 重要修正：有害なフォールバック処理の削除

### 発見された問題
- **府中オフィスルート**: 神田→府中（実際は45-50分）が「神田→日本橋（8分）」として返されていた
- **原因**: スクレイピングが失敗した際、エラーを返す代わりに偽のデータ（神田→日本橋）を捏造していた
- **影響**: デバッグが困難になり、ユーザーに誤った情報を提供するリスク

### 実施した修正
1. **ハードコーディングされたデフォルト値を削除**
   - 「神田→日本橋」の固定ルート（576-585行目）
   - デフォルトの到着駅「日本橋」（480行目）
   - デフォルトの時間値（8分、4分、1分など）

2. **適切なエラーハンドリングの実装**
   - ルート情報が取得できない場合は明確にエラーを返す
   - 部分的な情報しか取得できない場合もエラーとして処理

3. **妥当性チェックの追加**
   - 府中へのルートは最低30分かかるはずという検証を実装

### 教訓
- 「常に何か返す」設計は危険 - エラーは明確にエラーとして返すべき
- このコードは前回のClaude（私）のセッションで書かれたものだった

## 完了した作業

### 1. 基本的なスクレイピング機能の実装
- `google_maps_transit_final.py`: 電車ルートのスクレイピング
- `google_maps_walking_final.py`: 徒歩ルートのスクレイピング
- `google_maps_unified.py`: 電車・徒歩統合版

### 2. 主要な改善点
- **時刻ベースの正確な情報抽出**: directions_panelから時刻情報を正確に取得
- **徒歩ルート対応**: 電車ルートがない場合の自動フォールバック
- **待ち時間の適切な処理**: 最初の駅での待ち時間を0に設定

### 3. 検証結果
| ルート | Google Maps | 既存データ | 評価 |
|--------|------------|----------|------|
| ルフォンプログレ→Shizenkan | 7分 | 13分 | ✅ Google Mapsが現実的 |
| ルフォンプログレ→東京アメリカンクラブ | 7分 | 12分 | ✅ Google Mapsが現実的 |
| ルフォンプログレ→axle御茶ノ水 | 徒歩13分 | 電車17分 | ✅ 徒歩が適切 |
| ルフォンプログレ→Yawara | 35分(徒歩12分含む) | 29分(徒歩0分) | ✅ 徒歩時間が現実的 |

## 解決済みの課題

### unified.pyのタイムアウト問題（2025-08-11解決）
- **原因**: URLパラメータの誤り（3e0→3e3）、ダミー実装、詳細展開の欠如
- **解決策**: google_maps_combined.py（暫定ソリューション）を作成
- **詳細**: unified_timeout_analysis.mdを参照

### 物件数の誤認識問題（2025-08-12解決）
- **症状**: 物件数を184件と誤認識（実際は18件）
- **原因**: 物件名と駅名の両方が「name」キーを使用しているため
- **解決策**: properties配列の直下のnameキーのみを抽出
- **詳細**: property_name_extraction_guide.mdを参照

### JSONとindex.htmlの接続問題（2025-08-13解決）
- **症状**: index.htmlがJSONデータを正しく読み込めない
- **原因**: JSON構造とindex.htmlが期待する構造の不一致
  - JSONは`destination_id`、index.htmlは`destination`を期待
  - JSONはフラット構造、index.htmlは`details`オブジェクトを期待
  - JSONには`stations`フィールドがない
- **解決策**: loadDataFromJSON()関数内でJSONデータを期待される構造に変換
  - `destination_id` → `destination`へのマッピング
  - フラット構造から`details`オブジェクトへの変換
  - 空の`stations`配列の追加
- **影響**: 既存JSONファイルを変更せずに互換性を確保

## 現在の課題

### 乗り換え徒歩時間の精度問題
- **症状**: 実際1分の乗り換えを5分と認識
- **原因判明**: 時刻差（4分）を全て徒歩時間として計算
- **正解**: 徒歩1分 + 待ち時間3分
- **対策**: 「約○分」テキストを優先的に使用するロジックが必要

## 今後の作業計画

### Phase 1: 詳細デバッグ（現在着手中）
1. 乗り換えがあるルートのHTML詳細保存
2. 時刻情報と「約○分」テキストの位置関係を調査
3. 待ち時間と徒歩時間の判別方法を特定

### Phase 2: パターン分析
1. 複数の乗り換えルートでパターン収集
2. Google Mapsの表示パターンを分類
3. 判別ロジックの設計

### Phase 3: 実装改善
1. テキスト情報優先のロジック実装
2. 時刻差計算の精度向上
3. 検証機能の追加（5分以上の乗り換えは警告）

### Phase 4: 統合とテスト
1. APIサーバーへの統合
2. 全拠点での回帰テスト
3. properties.jsonの更新機能実装

## 重要な注意事項

1. **既存機能を壊さない**: 変更は慎重に、必ずバックアップを取る
2. **段階的な実装**: 小さな変更を積み重ねて検証
3. **ドキュメント更新**: 各段階で進捗を記録

## 技術的な発見事項

1. **Google Mapsの優位性**
   - リアルタイムの時刻表データ使用
   - 実際の距離に基づく徒歩時間計算
   - 都心部の電車間隔を適切に反映（2-3分間隔）

2. **スクレイピングのポイント**
   - directions_panelが最も信頼できる情報源
   - 時刻情報は"aria-label"属性に含まれる
   - ルートオプションは複数表示される場合がある

## 現在の課題と今後の対応

### 1. スクレイピングの安定性
- **問題**: 一部のルート（特に長距離）でスクレイピングが失敗する
- **現状**: エラーを明確に返すように修正済み（偽データの捏造は停止）
- **対策案**: 
  - Google MapsのHTML構造変更に対応するセレクタの更新
  - より堅牢な要素選択方法の実装
  - Google Maps Directions APIへの移行検討

### 2. 府中などの長距離ルート
- **問題**: Google Mapsページが正しく表示されてもルート情報を抽出できない
- **詳細**: デバッグファイルでルートは表示されているが、HTMLパターンが異なる
- **次のステップ**: 長距離ルート用の新しい抽出パターンの開発

## 次回作業開始時のチェックリスト

- [ ] このドキュメントを読んで状況を把握
- [ ] arrival_time_implementation_learnings.mdで今回の実装の詳細を確認
- [ ] 現在のシステムが「平日午前10時到着」で動作していることを認識
- [ ] ハイフン付き住所が正常に動作することを確認
- [ ] 変更前に必ずバックアップを取る（/home/ubuntu/backup/を使用）
- [ ] 物件数は184件（実際に使用されているproperties.jsonベース）
- [ ] **重要**: エラー時に偽のデータを返すフォールバック処理を絶対に実装しない
- [ ] google_maps_scraper_fix_2025-08-14.mdで有害なフォールバックの教訓を確認

## 🎯 2025-08-16 最新状況：v5スクレイパー完成

### 完了した重要マイルストーン

#### 1. メモリリーク問題の解決 ✅
- **問題**: Chrome Rendererメモリが無限増大
- **解決**: 9ルートごとのWebDriver再起動実装
- **結果**: 安定した長時間実行が可能に

#### 2. パフォーマンス最適化 ✅
- **改善前**: 平均160秒/ルート
- **改善後**: 平均37秒/ルート（4.3倍高速化）
- **手法**: 動的待機時間制御、キャッシュ活用

#### 3. Place ID抽出の完全実装 ✅
- **ChIJ形式**: 27文字のPlace ID（ChIJで始まる）を正確に抽出
- **簡略化**: ビル名・階数を削除して基本住所のみで検索
- **URL構築**: dataブロブに`!1m5!1m1!1s{place_id}`形式で埋め込み

#### 4. 住所ハルシネーション問題の根本解決 ✅
- **問題**: 実際のJSONではなく架空の目的地を生成していた
- **解決**: JsonDataLoaderクラスで常に実JSONファイルから読み込み
- **結果**: 100%正確な住所での検索を実現

#### 5. ユーザーフローエミュレーション成功 ✅
- **テスト結果**: 1物件×9目的地（合計9ルート）を完全取得
- **成功率**: 9/9（100%）
- **処理時間**: 平均37秒/ルート、総時間441.7秒

### 技術的成果

#### google_maps_scraper.py（統合版）
- v5の高速化とメモリ管理を統合
- Place ID抽出と適切なURL構築
- Chrome Rendererタイムアウト対策
- 段階的なフォールバック戦略

#### route_scraper_main.py
- 中間ファイル生成で障害時の復旧が可能
- 進捗トラッキングで処理状況を可視化
- バッチ処理と個別処理の切り替え

#### test_full_property.py
- HTMLレポート生成で結果を視覚的に確認
- 詳細な処理時間とエラー情報の記録
- 路線情報と運賃の抽出

### パフォーマンス指標

| 指標 | 値 | 備考 |
|------|-----|------|
| 平均処理時間 | 37秒/ルート | v4の160秒から大幅改善 |
| メモリ使用量 | 安定（1GB以下） | 9ルートごとに再起動 |
| 成功率 | 100%（9/9） | Place ID取得成功 |
| Place ID取得 | 100%成功 | ChIJ形式で正確に抽出 |

### 残課題と今後の作業

1. **全198ルート処理**
   - 23物件×9目的地の完全処理
   - 中間ファイルでの進捗管理
   - エラー時の自動リトライ

2. **json-generator.html統合**
   - 新規ユーザー登録フローの検証
   - スクレイピング結果の自動反映
   - properties.jsonの更新

3. **運用最適化**
   - Seleniumコンテナの定期再起動
   - ログローテーション
   - 監視アラート設定

## 関連ドキュメント

- [到着時刻実装の学び](arrival_time_implementation_learnings.md) - 2025-08-13の実装詳細
- [Python実行ガイド](python_execution_guide.md) - Dockerコンテナでの実行方法
- [物件名抽出ガイド](property_name_extraction_guide.md) - JSONデータ構造の理解
- [引き継ぎドキュメント](handover_document_20250813.md) - 2025-08-13時点の全体状況
- [スクレイパー修正記録](google_maps_scraper_fix_2025-08-14.md) - 有害なフォールバック処理の削除
- [スクレイピング問題分析](google_maps_scraping_issue_analysis.md) - 府中ルート問題の詳細分析