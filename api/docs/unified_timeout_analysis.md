# unified.pyタイムアウト問題の詳細分析

## 分析日時: 2025-08-11

## エグゼクティブサマリー

unified.pyのタイムアウト問題は、実際には「タイムアウト」ではなく、複数の設計上の問題が重なって発生している複合的な障害です。

## 根本原因の特定

### 1. URLパラメータの致命的な誤り

最も重大な問題は、URLパラメータ`3e0`の使用です。

```python
# 誤り（unified.py）
url += "data=!3m1!4b1!4m2!4m1!3e0"  # 3e0は車のルート

# 正解（transit_final.py）
url += "data=!3m1!4b1!4m2!4m1!3e3"  # 3e3は電車ルート
```

**影響**: Google Mapsが車のルートを返すため、電車情報が存在せず、解析が失敗します。

### 2. ダミー実装による解析の失敗

`parse_transit_route()`関数が実際の解析を行わず、固定値を返しています：

```python
def parse_transit_route(lines):
    """電車ルートの解析（簡略版）"""
    # ハードコードされた値を返すだけ
    trains = [{
        "line": "路線",
        "time": total_time - walk_to_station - walk_from_station,
        "from": "出発駅",
        "to": "到着駅",
        "wait_time": 0
    }]
```

### 3. 詳細展開処理の欠如

transit_final.pyには存在する重要な処理がunified.pyには実装されていません：

- 詳細ボタンのクリック
- 展開後の待機処理
- 正確なパネル要素の取得

## なぜ「タイムアウト」として現れるのか

1. **無限ループの可能性**
   - 電車ルートが見つからない→再試行→また見つからない
   - エラーハンドリングが不適切で、終了条件に到達しない

2. **要素待機の失敗**
   - 間違ったセレクタで要素を待機
   - 存在しない要素を待ち続ける

3. **フォールバック処理の問題**
   - 電車→徒歩の切り替えが正しく動作しない
   - 両方のルート取得に失敗して無限待機

## 構造的な問題

### 設計思想の違い

| 項目 | transit_final.py | unified.py |
|------|-----------------|------------|
| 目的 | 電車ルート専用 | 汎用（電車＋徒歩） |
| 実装 | 完全実装 | 簡略実装 |
| エラー処理 | 詳細 | 簡素 |
| デバッグ機能 | あり | なし |

### 統合の失敗

unified.pyは、transit_final.pyとwalking_final.pyを統合しようとしましたが：
- 核心的な処理が省略されている
- エラーケースの考慮が不足
- テストが不十分

## 解決策の方向性

### 短期的解決策

1. **暫定的な回避策**
   - transit_final.pyとwalking_final.pyを別々に呼び出す
   - 結果を外部で統合する

### 中長期的解決策

1. **正しい統合実装**
   - transit_final.pyの完全なロジックを組み込む
   - 適切なエラーハンドリング
   - デバッグ機能の追加

2. **段階的な移行**
   - まず動作確認済みのコードを使用
   - 徐々に統合版に移行
   - 各段階でテストを実施

## 影響と考慮事項

### 現在の影響

- unified.pyは使用不可能
- 電車と徒歩の自動切り替えが機能しない
- APIサーバーへの統合が遅延

### 修正時の考慮事項

1. **既存機能への影響**
   - transit_final.pyとwalking_final.pyは正常動作中
   - これらを壊さないよう注意

2. **パフォーマンス**
   - 2つのスクリプトを呼び出すとレスポンスが遅くなる
   - キャッシュやタイムアウト設定の調整が必要

3. **保守性**
   - コードの重複を避ける
   - 共通処理は関数化
   - ドキュメントの充実

## 推奨アクションプラン

1. **即時対応**（今日中）
   - transit_final.pyとwalking_final.pyを使った暫定ソリューション作成
   - APIサーバーに組み込んでテスト

2. **短期対応**（1週間以内）
   - unified_fixed.pyの完全テスト
   - 段階的な本番環境への適用

3. **中期対応**（1ヶ月以内）
   - 全拠点でのテスト完了
   - properties.jsonの更新
   - ドキュメントの整備

## 学んだ教訓

1. **簡略化の危険性**
   - 「簡略版」として重要な処理を省略すると動作しない
   - 動作確認なしのコードは本番に入れない

2. **統合の複雑さ**
   - 2つの独立したスクリプトの統合は想像以上に複雑
   - 段階的な統合が重要

3. **テストの重要性**
   - 基本的な動作確認を怠らない
   - エラーケースのテストも必須