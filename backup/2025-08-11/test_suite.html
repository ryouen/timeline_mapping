<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>JSON Generator - åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆ</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1e1e1e; color: #00ff00; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #00ff00; }
        .test-case { margin: 10px 0; padding: 10px; background: #2a2a2a; }
        .pass { color: #00ff00; }
        .fail { color: #ff0000; }
        .pending { color: #ffff00; }
        .error-detail { color: #ff8888; margin-left: 20px; font-size: 0.9em; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        #results { margin-top: 20px; }
        pre { background: #333; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸ§ª JSON Generator - åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆ</h1>
    
    <div class="test-section">
        <h2>ãƒ†ã‚¹ãƒˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</h2>
        <button onclick="runAllTests()">å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
        <button onclick="runAPITests()">APIãƒ†ã‚¹ãƒˆã®ã¿</button>
        <button onclick="runJSTests()">JavaScriptãƒ†ã‚¹ãƒˆã®ã¿</button>
        <button onclick="clearResults()">çµæœã‚¯ãƒªã‚¢</button>
    </div>

    <div id="results"></div>

    <script>
        const testResults = [];
        let testCount = 0;
        let passCount = 0;
        let failCount = 0;

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function logTest(name, result, details = '') {
            testCount++;
            const status = result ? 'pass' : 'fail';
            if (result) passCount++; else failCount++;
            
            const resultHtml = `
                <div class="test-case">
                    <span class="${status}">${result ? 'âœ…' : 'âŒ'}</span> ${name}
                    ${details ? `<div class="error-detail">${details}</div>` : ''}
                </div>
            `;
            
            document.getElementById('results').innerHTML += resultHtml;
            testResults.push({ name, result, details });
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            testResults.length = 0;
            testCount = 0;
            passCount = 0;
            failCount = 0;
        }

        // ==================== API ãƒ†ã‚¹ãƒˆ ====================
        
        async function testDestinationsParsing() {
            console.log('Testing: Destinations Parsing');
            
            // ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: åŸºæœ¬çš„ãªå…¥åŠ›
            const testCase1 = {
                input: "ç§ã®ä¼šç¤¾ã¯æ±äº¬éƒ½åƒä»£ç”°åŒºç¥ç”°é ˆç”°ç”º1-20ã«ã‚ã‚Šã¾ã™ã€‚é€±3å›é€šã£ã¦ã„ã¾ã™ã€‚",
                expected: {
                    hasDestinations: true,
                    firstDestination: {
                        hasId: true,
                        hasCategory: true,
                        hasAddress: true,
                        hasOwner: true,
                        hasMonthlyFrequency: true,
                        monthlyFrequencyValue: 13.2 // é€±3 * 4.4
                    }
                }
            };

            try {
                const response = await fetch('/timeline-mapping/api/generate.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'parseDestinations',
                        text: testCase1.input
                    })
                });

                if (!response.ok) {
                    logTest('API: ç›®çš„åœ°è§£æ - ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', false, `Status: ${response.status}`);
                    return;
                }

                const data = await response.json();
                
                // ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
                if (data.error) {
                    logTest('API: ç›®çš„åœ°è§£æ - ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹', false, data.error);
                    return;
                }

                // ãƒ‡ãƒ¼ã‚¿æ§‹é€ ãƒã‚§ãƒƒã‚¯
                logTest('API: ç›®çš„åœ°è§£æ - destinationsé…åˆ—ã®å­˜åœ¨', !!data.destinations);
                
                if (data.destinations && data.destinations.length > 0) {
                    const dest = data.destinations[0];
                    logTest('API: ç›®çš„åœ°è§£æ - IDã®å­˜åœ¨', !!dest.id);
                    logTest('API: ç›®çš„åœ°è§£æ - ã‚«ãƒ†ã‚´ãƒªã®å­˜åœ¨', !!dest.category);
                    logTest('API: ç›®çš„åœ°è§£æ - ä½æ‰€ã®å­˜åœ¨', !!dest.address);
                    logTest('API: ç›®çš„åœ°è§£æ - ã‚ªãƒ¼ãƒŠãƒ¼ã®å­˜åœ¨', !!dest.owner);
                    logTest('API: ç›®çš„åœ°è§£æ - æœˆé–“é »åº¦ã®å­˜åœ¨', !!dest.monthly_frequency);
                    logTest('API: ç›®çš„åœ°è§£æ - æœˆé–“é »åº¦ã®è¨ˆç®—', 
                        Math.abs(dest.monthly_frequency - 13.2) < 0.1,
                        `æœŸå¾…å€¤: 13.2, å®Ÿéš›: ${dest.monthly_frequency}`
                    );
                }
                
            } catch (error) {
                logTest('API: ç›®çš„åœ°è§£æ - åŸºæœ¬ãƒ†ã‚¹ãƒˆ', false, error.message);
            }
        }

        async function testComplexDestinationsParsing() {
            console.log('Testing: Complex Destinations Parsing');
            
            const complexInput = `ShizenkanUniv. ã€’103-0027 æ±äº¬éƒ½ä¸­å¤®åŒºæ—¥æœ¬æ©‹ï¼’ä¸ç›®ï¼•âˆ’ï¼‘ é€±ï¼“å›
æ—¥æœ¬æ©‹(ã‚¸ãƒ ) ã€’103-0022 æ±äº¬éƒ½ä¸­å¤®åŒºæ—¥æœ¬æ©‹å®¤ç”ºï¼“ä¸ç›®ï¼’âˆ’ï¼‘ é€±ï¼‘å›
æ±äº¬é§… æ±äº¬é§…æ–°å¹¹ç·šä¹—ã‚Šå ´ æœˆï¼’ï½ï¼“å›

ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã¯
ç¥è°·ç”ºã‚ªãƒ•ã‚£ã‚¹ ã€’105-0001 æ±äº¬éƒ½æ¸¯åŒºè™ãƒé–€ï¼”ä¸ç›®ï¼’âˆ’ï¼– é€±ï¼‘ï½ï¼’å›
æ—¥æœ¬æ©‹(ã‚¸ãƒ ) ã€’103-0022 æ±äº¬éƒ½ä¸­å¤®åŒºæ—¥æœ¬æ©‹å®¤ç”ºï¼“ä¸ç›®ï¼’âˆ’ï¼‘ é€±ï¼‘å›`;

            try {
                const response = await fetch('/timeline-mapping/api/generate.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'parseDestinations',
                        text: complexInput
                    })
                });

                const data = await response.json();
                
                if (data.destinations) {
                    // é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆæ—¥æœ¬æ©‹ã‚¸ãƒ ã¯ both ã«ãªã‚‹ã¹ãï¼‰
                    const gymEntries = data.destinations.filter(d => 
                        d.name && d.name.includes('æ—¥æœ¬æ©‹') && d.name.includes('ã‚¸ãƒ ')
                    );
                    
                    logTest('API: è¤‡é›‘ãªå…¥åŠ› - é‡è¤‡ã®çµ±åˆ', 
                        gymEntries.length === 1,
                        `ã‚¸ãƒ ã‚¨ãƒ³ãƒˆãƒªæ•°: ${gymEntries.length}`
                    );
                    
                    if (gymEntries.length > 0) {
                        logTest('API: è¤‡é›‘ãªå…¥åŠ› - å…±æœ‰ã‚ªãƒ¼ãƒŠãƒ¼è¨­å®š', 
                            gymEntries[0].owner === 'both',
                            `ã‚ªãƒ¼ãƒŠãƒ¼: ${gymEntries[0].owner}`
                        );
                    }
                    
                    // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼å°‚ç”¨ã‚¨ãƒ³ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯
                    const partnerOnly = data.destinations.filter(d => d.owner === 'partner');
                    logTest('API: è¤‡é›‘ãªå…¥åŠ› - ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼å°‚ç”¨ã‚¨ãƒ³ãƒˆãƒª', 
                        partnerOnly.length > 0,
                        `ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚¨ãƒ³ãƒˆãƒªæ•°: ${partnerOnly.length}`
                    );
                    
                    // æœˆé–“é »åº¦ã®ç¯„å›²è¨ˆç®—ãƒã‚§ãƒƒã‚¯ï¼ˆæœˆ2-3å› = 2.5ï¼‰
                    const tokyoStation = data.destinations.find(d => 
                        d.name && d.name.includes('æ±äº¬é§…')
                    );
                    if (tokyoStation) {
                        logTest('API: è¤‡é›‘ãªå…¥åŠ› - ç¯„å›²é »åº¦ã®è¨ˆç®—', 
                            Math.abs(tokyoStation.monthly_frequency - 2.5) < 0.1,
                            `æ±äº¬é§…ã®é »åº¦: ${tokyoStation.monthly_frequency}`
                        );
                    }
                }
                
            } catch (error) {
                logTest('API: è¤‡é›‘ãªå…¥åŠ›ãƒ†ã‚¹ãƒˆ', false, error.message);
            }
        }

        async function testMapsAPI() {
            console.log('Testing: Maps API');
            
            try {
                const response = await fetch('/timeline-mapping/api/maps.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        origin: 'æ±äº¬éƒ½åƒä»£ç”°åŒºç¥ç”°é ˆç”°ç”º1-20',
                        destination: 'æ±äº¬éƒ½ä¸­å¤®åŒºæ—¥æœ¬æ©‹2-5-1',
                        mode: 'transit'
                    })
                });

                logTest('API: Maps - ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', response.ok, `Status: ${response.status}`);
                
                if (response.ok) {
                    const data = await response.json();
                    logTest('API: Maps - ãƒ«ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã®å­˜åœ¨', !!data.routes);
                    
                    if (data.routes && data.routes.length > 0) {
                        const route = data.routes[0];
                        logTest('API: Maps - çµŒè·¯æƒ…å ±ã®å­˜åœ¨', !!route.legs);
                        
                        if (route.legs && route.legs.length > 0) {
                            const leg = route.legs[0];
                            logTest('API: Maps - æ‰€è¦æ™‚é–“ã®å­˜åœ¨', !!leg.duration);
                            logTest('API: Maps - ã‚¹ãƒ†ãƒƒãƒ—æƒ…å ±ã®å­˜åœ¨', !!leg.steps);
                        }
                    }
                }
                
            } catch (error) {
                logTest('API: Maps ãƒ†ã‚¹ãƒˆ', false, error.message);
            }
        }

        // ==================== JavaScript é–¢æ•°ãƒ†ã‚¹ãƒˆ ====================
        
        function testParseFrequency() {
            console.log('Testing: parseFrequency function');
            
            // parseFrequencyé–¢æ•°ã‚’å†å®šç¾©ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
            function parseFrequency(text) {
                const weekMatch = text.match(/é€±(\d+)/);
                if (weekMatch) return parseFloat(weekMatch[1]) * 4.4;
                
                const monthRangeMatch = text.match(/æœˆ(\d+)[~\-ãƒ¼ï½](\d+)/);
                if (monthRangeMatch) return (parseFloat(monthRangeMatch[1]) + parseFloat(monthRangeMatch[2])) / 2;
                
                const monthMatch = text.match(/æœˆ(\d+)/);
                if (monthMatch) return parseFloat(monthMatch[1]);
                
                return 4;
            }
            
            // ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹
            const testCases = [
                { input: 'é€±3å›', expected: 13.2 },
                { input: 'é€±1å›ç¨‹åº¦', expected: 4.4 },
                { input: 'æœˆ4å›', expected: 4 },
                { input: 'æœˆ2ï½3å›', expected: 2.5 },
                { input: 'æœˆ1-2å›', expected: 1.5 },
                { input: 'æœˆï¼ï½ï¼‘å›', expected: 0.5 },
                { input: 'ä¸æ˜', expected: 4 } // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
            ];
            
            testCases.forEach(tc => {
                const result = parseFrequency(tc.input);
                logTest(`JS: parseFrequency("${tc.input}")`, 
                    Math.abs(result - tc.expected) < 0.01,
                    `æœŸå¾…å€¤: ${tc.expected}, å®Ÿéš›: ${result}`
                );
            });
        }

        function testGenerateId() {
            console.log('Testing: generateId function');
            
            // generateIdé–¢æ•°ã‚’å†å®šç¾©ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
            function generateId(name) {
                if (!name) return 'dest_' + Date.now();
                
                // æ—¥æœ¬èªã‚’ãƒ­ãƒ¼ãƒå­—ã«å¤‰æ›ã™ã‚‹ç°¡æ˜“å®Ÿè£…
                const romanized = name
                    .toLowerCase()
                    .replace(/[^\w\s]/gi, '')
                    .replace(/\s+/g, '_')
                    .substring(0, 30);
                
                return romanized || 'dest_' + Date.now();
            }
            
            const testCases = [
                { input: 'ShizenkanUniv.', expected: /shizenkanuniv/ },
                { input: 'æ—¥æœ¬æ©‹(ã‚¸ãƒ )', expected: /dest_\d+/ }, // æ—¥æœ¬èªã¯å¤‰æ›ã§ããªã„ã®ã§ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
                { input: 'axleå¾¡èŒ¶ãƒæ°´', expected: /axle/ },
                { input: '', expected: /dest_\d+/ },
                { input: null, expected: /dest_\d+/ }
            ];
            
            testCases.forEach(tc => {
                const result = generateId(tc.input);
                logTest(`JS: generateId("${tc.input}")`, 
                    tc.expected.test(result),
                    `çµæœ: ${result}`
                );
            });
        }

        // ==================== ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆ ====================
        
        async function testEdgeCases() {
            console.log('Testing: Edge Cases');
            
            // ç©ºã®å…¥åŠ›
            try {
                const response = await fetch('/timeline-mapping/api/generate.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'parseDestinations',
                        text: ''
                    })
                });
                
                const data = await response.json();
                logTest('Edge: ç©ºã®å…¥åŠ›', 
                    data.destinations === undefined || data.destinations.length === 0,
                    'Empty input should return empty or no destinations'
                );
            } catch (error) {
                logTest('Edge: ç©ºã®å…¥åŠ›', false, error.message);
            }
            
            // ä¸æ­£ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³
            try {
                const response = await fetch('/timeline-mapping/api/generate.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'invalidAction',
                        text: 'test'
                    })
                });
                
                const data = await response.json();
                logTest('Edge: ä¸æ­£ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³', 
                    !!data.error,
                    'Invalid action should return error'
                );
            } catch (error) {
                logTest('Edge: ä¸æ­£ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³', true, 'Error thrown as expected');
            }
            
            // è¶…é•·æ–‡å…¥åŠ›ï¼ˆ1000æ–‡å­—ä»¥ä¸Šï¼‰
            const longText = 'ãƒ†ã‚¹ãƒˆ '.repeat(200);
            try {
                const response = await fetch('/timeline-mapping/api/generate.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'parseDestinations',
                        text: longText
                    })
                });
                
                logTest('Edge: è¶…é•·æ–‡å…¥åŠ›', 
                    response.ok || response.status === 413,
                    `Status: ${response.status}`
                );
            } catch (error) {
                logTest('Edge: è¶…é•·æ–‡å…¥åŠ›', false, error.message);
            }
        }

        // ==================== ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ ====================
        
        function testDataValidation() {
            console.log('Testing: Data Validation');
            
            // ã‚«ãƒ†ã‚´ãƒªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            const validCategories = ['school', 'gym', 'office', 'station', 'airport'];
            const testCategory = 'school';
            logTest('Validation: ã‚«ãƒ†ã‚´ãƒªæ¤œè¨¼', 
                validCategories.includes(testCategory),
                `Category: ${testCategory}`
            );
            
            // ã‚ªãƒ¼ãƒŠãƒ¼ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            const validOwners = ['you', 'partner', 'both'];
            const testOwner = 'you';
            logTest('Validation: ã‚ªãƒ¼ãƒŠãƒ¼æ¤œè¨¼', 
                validOwners.includes(testOwner),
                `Owner: ${testOwner}`
            );
            
            // é »åº¦ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ0ä»¥ä¸Šã®æ•°å€¤ï¼‰
            const testFrequencies = [0, 0.5, 1, 13.2, -1, 'invalid'];
            testFrequencies.forEach(freq => {
                const isValid = typeof freq === 'number' && freq >= 0;
                logTest(`Validation: é »åº¦æ¤œè¨¼ (${freq})`, 
                    isValid === (freq >= 0 && typeof freq === 'number'),
                    `Valid: ${isValid}`
                );
            });
        }

        // ==================== çµ±åˆãƒ†ã‚¹ãƒˆ ====================
        
        async function testFullWorkflow() {
            console.log('Testing: Full Workflow');
            
            // Step 1: ç›®çš„åœ°è¿½åŠ 
            // Step 2: ç‰©ä»¶è¿½åŠ 
            // Step 3: ãƒ«ãƒ¼ãƒˆæ¤œç´¢
            // Step 4: JSONä¿å­˜
            
            // ã“ã®éƒ¨åˆ†ã¯å®Ÿéš›ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
            logTest('Workflow: å®Œå…¨ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆ', true, 'Manual verification required');
        }

        // ==================== ãƒ†ã‚¹ãƒˆå®Ÿè¡Œé–¢æ•° ====================
        
        async function runAllTests() {
            clearResults();
            document.getElementById('results').innerHTML = '<h2>ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</h2>';
            
            await testDestinationsParsing();
            await testComplexDestinationsParsing();
            await testMapsAPI();
            testParseFrequency();
            testGenerateId();
            await testEdgeCases();
            testDataValidation();
            await testFullWorkflow();
            
            // ã‚µãƒãƒªãƒ¼è¡¨ç¤º
            const summary = `
                <div class="test-section">
                    <h2>ãƒ†ã‚¹ãƒˆã‚µãƒãƒªãƒ¼</h2>
                    <div>ç·ãƒ†ã‚¹ãƒˆæ•°: ${testCount}</div>
                    <div class="pass">æˆåŠŸ: ${passCount}</div>
                    <div class="fail">å¤±æ•—: ${failCount}</div>
                    <div>æˆåŠŸç‡: ${Math.round(passCount/testCount*100)}%</div>
                </div>
            `;
            
            document.getElementById('results').innerHTML = summary + document.getElementById('results').innerHTML;
        }
        
        async function runAPITests() {
            clearResults();
            document.getElementById('results').innerHTML = '<h2>APIãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</h2>';
            
            await testDestinationsParsing();
            await testComplexDestinationsParsing();
            await testMapsAPI();
            await testEdgeCases();
            
            displaySummary();
        }
        
        async function runJSTests() {
            clearResults();
            document.getElementById('results').innerHTML = '<h2>JavaScriptãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</h2>';
            
            testParseFrequency();
            testGenerateId();
            testDataValidation();
            
            displaySummary();
        }
        
        function displaySummary() {
            const summary = `
                <div class="test-section">
                    <h2>ãƒ†ã‚¹ãƒˆã‚µãƒãƒªãƒ¼</h2>
                    <div>ç·ãƒ†ã‚¹ãƒˆæ•°: ${testCount}</div>
                    <div class="pass">æˆåŠŸ: ${passCount}</div>
                    <div class="fail">å¤±æ•—: ${failCount}</div>
                    <div>æˆåŠŸç‡: ${Math.round(passCount/testCount*100)}%</div>
                </div>
            `;
            document.getElementById('results').innerHTML = summary + document.getElementById('results').innerHTML;
        }
    </script>
</body>
</html>